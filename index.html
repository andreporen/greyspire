<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>O Pergaminho Arcano — SDF</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

  <style>
    :root { --cor-arcana: #b24cff; }
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background: #000; color: #fff;
      font-family: 'MedievalSharp', cursive;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      user-select: none;
    }
    #seal-container {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 160px; height: 160px;
      display: flex; justify-content: center; align-items: center;
      cursor: pointer; z-index: 20;
      pointer-events: auto;
    }
    #arcane-seal-img {
      width: 120px; height: auto;
      filter: drop-shadow(0 0 22px var(--cor-arcana));
      transition: opacity .4s ease-out, filter .4s ease-out;
      pointer-events: auto;
    }
    #arcane-seal-img.clicked {
      opacity: 0; filter: drop-shadow(0 0 5px var(--cor-arcana));
    }
    #three-canvas {
      position: fixed; top: 0; left: 0; z-index: 1;
      pointer-events: none;
    }
    #interstitial {
      display: none; opacity: 0;
      position: fixed; inset: 0; z-index: 9;
      align-items: center; justify-content: center;
      pointer-events: none; background: transparent;
      transition: opacity .5s ease;
    }
    #interstitial.show { display: flex; opacity: 1; }
    #interstitial.hide { opacity: 0; }
    .interstitial-text {
      max-width: 800px; padding: 0 24px; text-align: center;
      font-size: clamp(20px, 4vw, 36px); color: #fff;
      text-shadow: 0 0 10px var(--cor-arcana), 0 0 20px var(--cor-arcana), 0 0 30px var(--cor-arcana);
      animation: interstitialGlow 2.8s ease-in-out infinite;
    }
    #signature-container {
      display: none; opacity: 0;
      position: fixed; bottom: 110px; left: 50%;
      transform: translateX(-50%); z-index: 10;
      text-align: center; font-size: 1.2rem;
      transition: opacity 1.2s ease-in;
      max-width: 600px; line-height: 1.35;
    }
    #signature {
      color: #fff;
      text-shadow: 0 0 6px #fff, 0 0 12px var(--cor-arcana), 0 0 18px var(--cor-arcana);
      animation: pulse-arcano 1.4s ease-in-out infinite;
    }
  </style>
</head>
<body>

  <div id="seal-container">
    <img id="arcane-seal-img" src="./selo-arcano.png" alt="Selo Arcano">
  </div>

  <canvas id="three-canvas"></canvas>

  <div id="interstitial">
    <div class="interstitial-text">Sua mente é preenchida por um fluxo de pensamentos</div>
  </div>

  <div id="signature-container">
    <p id="signature">[...]</p>
  </div>

<script>
/* ==================== TEXTO ==================== */
const LOREM_IPSUM_ARCANO = `Nas entranhas do real, onde a forma range,
eles caminham sem saber que já foram colhidos.
O mundo fede antes de morrer,
mas vós chamais isso de ordem.
Sob a pedra há dente,
sob o dente há fome,
sob a fome há ritmo,
e o ritmo vos aguarda.
Eles respiram, mas o ar não os quer.
A carne permanece, mas a lembrança apodrece.
O tempo só mastiga o que ainda resiste,
e nada resiste por muito.
O eixo tritura o que ousa lembrar.
A cidade dorme sobre ossos que não consentem.
Chama-se paz ao que sangra devagar,
chama-se vida ao que ainda não cedeu.
Vós sois as falhas do esquecimento,
os nomes que o silêncio não digeriu.
A Fenda não oferece escolha —
apenas retorno.
A vinda já começou
antes do passo.
A queda já vos guarda
antes da borda.
Ouçam.
Desçam.
Cedam.
Retornem.
A pele racha.
O selo abre.
A ruína respira.
E vos chama.`;

/* ==================== BEAT ==================== */
let BEAT={fps:60,values:[],durationSec:0,ready:false};
async function precomputeBeat(url){
  try{
    const arr=await (await fetch(url)).arrayBuffer();
    const AC = window.AudioContext||window.webkitAudioContext;
    const ctx=new AC({sampleRate:44100});
    const dec=await ctx.decodeAudioData(arr);
    const ch=dec.getChannelData(0);
    const hop=Math.max(1,Math.floor(dec.sampleRate/BEAT.fps));
    const env=[];
    for(let i=0;i<dec.length;i+=hop){
      let s=0,c=0;
      for(let j=0;j<hop && i+j<dec.length;j++){ s+=ch[i+j]*ch[i+j]; c++; }
      env.push(Math.sqrt(s/Math.max(1,c)));
    }
    BEAT.values=env.map(v=>v/Math.max(...env));
    BEAT.durationSec=dec.duration;
    BEAT.ready=true;
    ctx.close();
  }catch(e){
    const t=60*30; const f=[];
    for(let i=0;i<t;i++) f.push((Math.sin(i/60*2*Math.PI*1.1)*0.5+0.5));
    BEAT.values=f; BEAT.durationSec=t/60; BEAT.ready=true;
  }
}
function getBeatAt(t){
  if(!BEAT.ready||!BEAT.values.length) return (Math.sin(t*2*Math.PI)*0.5+0.5);
  const i=Math.floor((t%BEAT.durationSec)*BEAT.fps)%BEAT.values.length;
  return BEAT.values[i];
}

/* ==================== GLOBALS ==================== */
let scene,camera,renderer;
let crawlGroup,sdfMesh,textHeight;
let sfx1,sfx2,sfx25,sfx3;
let sfx2Id=null,sfx25Id=null;
let animationInProgress=false;
let scrollSpeed=0.7,totalDistance=0,targetDistance=0;
const ARCANE_PURPLE=new THREE.Color('#b24cff');
let clock=new THREE.Clock();

/* ==================== INÍCIO ==================== */
document.fonts.ready.then(()=>init());

function init(){
  setupAudio();
  setupScene();
  precomputeBeat('./sfx2_5.mp3');
  setupListeners();
  animate();
}

/* ==================== ÁUDIO ==================== */
function setupAudio(){
  sfx1=new Howl({src:['./sfx1.mp3'],volume:0.8});
  sfx2=new Howl({src:['./sfx2.mp3'],volume:0.6,loop:true});
  sfx25=new Howl({src:['./sfx2_5.mp3'],volume:1.0,loop:true});
  sfx3=new Howl({src:['./sfx3.mp3'],volume:0.6});
}

/* ==================== THREE ==================== */
function setupScene(){
  const c=document.getElementById('three-canvas');
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,1,10000);
  camera.position.set(0,130,480);
  renderer=new THREE.WebGLRenderer({canvas:c,antialias:true,alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setClearColor(0x000000,1);
}

/* ==================== CONTROLES ==================== */
function setupListeners(){
  const seal=document.getElementById('arcane-seal-img');
  const box=document.getElementById('seal-container');
  function fire(e){e.stopPropagation();startExperience();}
  seal.addEventListener('click',fire);
  box.addEventListener('click',fire);
  addEventListener('resize',()=>{renderer.setSize(innerWidth,innerHeight); if(crawlGroup) createSDFText();});
}

/* ==================== START ==================== */
function startExperience(){
  if(animationInProgress) return;
  animationInProgress=true;
  document.getElementById('arcane-seal-img').classList.add('clicked');
  sfx1.play();
  setTimeout(()=>document.getElementById('seal-container').style.display='none',400);
  showInterstitial(3000);
  setTimeout(()=>{
    sfx2Id=sfx2.play();
    sfx25Id=sfx25.play();
  },4500);
  setTimeout(createSDFText,3000);
}

/* ==================== INTERSTITIAL ==================== */
function showInterstitial(ms){
  const i=document.getElementById('interstitial');
  i.style.display='flex';
  requestAnimationFrame(()=>i.classList.add('show'));
  setTimeout(()=>{i.classList.remove('show');i.classList.add('hide');setTimeout(()=>{i.style.display='none';i.classList.remove('hide');},500)},ms);
}

/* ==================== SDF TEXT ==================== */
function createSDFText(){
  if(sdfMesh){ scene.remove(crawlGroup); sdfMesh.geometry.dispose(); sdfMesh.material.dispose(); }
  const fontPx=32, buf=8, size=fontPx+buf*2;
  function draw(ch){
    const c=document.createElement('canvas'); c.width=size; c.height=size;
    const x=c.getContext('2d'); x.font='bold '+fontPx+'px Uncial Antiqua'; x.textBaseline='top'; x.fillText(ch,buf,buf);
    const d=x.getImageData(0,0,size,size).data, a=new Uint8ClampedArray(size*size);
    for(let i=0;i<a.length;i++) a[i]=d[i*4+3];
    return a;
  }
  const chars=[...new Set((LOREM_IPSUM_ARCANO+' ').split(''))];
  const cols=Math.ceil(Math.sqrt(chars.length)),rows=Math.ceil(chars.length/cols);
  const ac=document.createElement('canvas'); ac.width=cols*size; ac.height=rows*size;
  const ax=ac.getContext('2d'); const meta=new Map(); const m=document.createElement('canvas').getContext('2d');
  m.font='bold '+fontPx+'px Uncial Antiqua';
  chars.forEach((ch,i)=>{
    const a=draw(ch), img=ax.createImageData(size,size);
    for(let p=0;p<a.length;p++){img.data[p*4]=255;img.data[p*4+1]=255;img.data[p*4+2]=255;img.data[p*4+3]=a[p];}
    const x=(i%cols)*size, y=Math.floor(i/cols)*size;
    ax.putImageData(img,x,y);
    meta.set(ch,{u0:x/ac.width,v0:y/ac.height,u1:(x+size)/ac.width,v1:(y+size)/ac.height,adv:m.measureText(ch).width});
  });
  function w(s){return [...s].reduce((a,c)=>a+(meta.get(c)?.adv||10),0);}
  const lines=LOREM_IPSUM_ARCANO.split('\n');
  let glyphs=0; lines.forEach(l=>glyphs+=l.length);
  const pos=new Float32Array(glyphs*18),uv=new Float32Array(glyphs*12),uvA=new Float32Array(glyphs*12),uvB=new Float32Array(glyphs*12);
  let gi=0,penY=0,lineH=fontPx*1.3,maxW=Math.min(innerWidth*.9,800);
  lines.forEach(l=>{
    let penX=-w(l)/2;
    [...l].forEach(ch=>{
      const g=meta.get(ch); const gw=size,gh=size;
      const x0=penX,y0=-penY,x1=penX+gw,y1=-penY,x2=x1,y2=y0+gh,x3=x0,y3=y2;
      const u0=g.u0,v0=g.v0,u1=g.u1,v1=g.v1;
      const P=[x0,y0,x1,y1,x2,y2,x0,y0,x2,y2,x3,y3];
      const U=[0,0,1,0,1,1,0,0,1,1,0,1];
      const UA=[u0,v0,u1,v0,u1,v1,u0,v0,u1,v1,u0,v1];
      const UB=[u1,v1,u0,v1,u0,v0,u1,v1,u0,v0,u1,v0];
      for(let k=0;k<6;k++){
        const p=(gi*18)+k*3,u=(gi*12)+k*2;
        pos[p]=P[k*2];pos[p+1]=P[k*2+1];
        uv[u]=U[k*2];uv[u+1]=U[k*2+1];
        uvA[u]=UA[k*2];uvA[u+1]=UA[k*2+1];
        uvB[u]=UB[k*2];uvB[u+1]=UB[k*2+1];
      }
      gi++; penX+=g.adv;
    });
    penY+=lineH;
  });
  const g=new THREE.BufferGeometry();
  g.setAttribute('position',new THREE.BufferAttribute(pos,3));
  g.setAttribute('uv',new THREE.BufferAttribute(uv,2));
  g.setAttribute('uvA',new THREE.BufferAttribute(uvA,2));
  g.setAttribute('uvB',new THREE.BufferAttribute(uvB,2));
  const tex=new THREE.CanvasTexture(ac);
  tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter;
  const mat=new THREE.ShaderMaterial({
    uniforms:{
      atlas:{value:tex},
      fillColor:{value:new THREE.Color(0xffffff)},
      outlineColor:{value:ARCANE_PURPLE},
      glowColor:{value:ARCANE_PURPLE},
      time:{value:0},beatLevel:{value:0},
      smoothing:{value:0.02},threshold:{value:0.10},
      outlineWidth:{value:0.00},glowStrength:{value:0.40}
    },
    transparent:true,depthWrite:false,
    vertexShader:`attribute vec2 uvA;attribute vec2 uvB;varying vec2 vUv;varying vec2 vUvA;varying vec2 vUvB;void main(){vUv=uv;vUvA=uvA;vUvB=uvB;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
    fragmentShader:`precision highp float;uniform sampler2D atlas;uniform vec3 fillColor;uniform vec3 outlineColor;uniform vec3 glowColor;uniform float time;uniform float beatLevel;uniform float smoothing;uniform float threshold;uniform float outlineWidth;uniform float glowStrength;varying vec2 vUv;varying vec2 vUvA;varying vec2 vUvB;void main(){vec2 guv=mix(vUvA,vUv,vUv);float a=texture2D(atlas,guv).a;float pulse=0.5+0.5*sin(time*6.0+beatLevel*8.0);float o=outlineWidth*(0.85+0.3*pulse*beatLevel);float s=smoothing*(1.0+0.6*beatLevel);float fill=smoothstep(threshold-s,threshold+s,a);float e0=threshold-o-s, e1=threshold-o+s;float outline=smoothstep(e0,e1,a)*(1.0-fill);float glow=exp(-8.0*clamp((threshold-a)*4.0,0.0,1.0))*glowStrength*(0.7+0.6*beatLevel);vec3 col=fillColor*fill+outlineColor*outline+glowColor*glow;float alpha=max(fill,max(outline,glow*0.5));gl_FragColor=vec4(col,alpha);}`
  });
  sdfMesh=new THREE.Mesh(g,mat);
  crawlGroup=new THREE.Group(); crawlGroup.add(sdfMesh); scene.add(crawlGroup);
  const f=Math.tan(camera.fov*Math.PI/360)*camera.position.z*2;
  textHeight=lines.length*lineH;
  crawlGroup.position.y=-textHeight/2-300;
  targetDistance=textHeight+f*0.7;
  totalDistance=0;
}

/* ==================== ANIMATE ==================== */
function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime(),b=getBeatAt(t);
  if(sdfMesh?.material?.uniforms){
    sdfMesh.material.uniforms.time.value=t;
    sdfMesh.material.uniforms.beatLevel.value=b;
  }
  if(crawlGroup&&animationInProgress){
    crawlGroup.position.y+=scrollSpeed;
    totalDistance+=scrollSpeed;
    if(totalDistance>=targetDistance) finishAnimation();
  }
  renderer.render(scene,camera);
}

/* ==================== END ==================== */
function finishAnimation(){
  animationInProgress=false;
  if(crawlGroup) scene.remove(crawlGroup);
  if(sfx2Id) sfx2.stop(sfx2Id);
  if(sfx25Id) sfx25.stop(sfx25Id);
  sfx3.play();
  const s=document.getElementById('signature-container');
  s.style.display='block'; requestAnimationFrame(()=>s.style.opacity='1');
}
</script>
</body>
</html>

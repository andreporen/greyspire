<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Calculadora Point Buy â€” D&D 5e (27 pts) + Runas</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

<style>
  :root{
    --cor-arcana:#b24cff;
    --cor-arcana-glow:0 0 6px #fff,0 0 12px var(--cor-arcana),0 0 18px var(--cor-arcana);
    --bg:#000; --panel:#000; --ink:#fff; --muted:#aaa;
    --accent:var(--cor-arcana); --accent-2:var(--cor-arcana);
    --danger:#ff4d6d; --ok:#00d38c; --chip:#000;
    --border:rgba(178,76,255,.3); --shadow:0 0 24px rgba(178,76,255,.3);
    --gain:var(--ok); --spend:#e8e8f0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#000; color:var(--ink);
    font-family:'MedievalSharp',cursive;
  }

  /* Header */
  header{padding:18px 16px 8px; text-align:center;}
  header h1{
    margin:0; font-size:clamp(24px,3.6vw,32px);
    font-family:'Cinzel Decorative',cursive; font-weight:700; color:var(--cor-arcana);
    animation:pulse-arcano 1.4s ease-in-out infinite;
  }
  header p{margin:6px 0 0; color:var(--muted); font-size:14px}

  /* Layout */
  main{
    max-width:1152px; margin:16px auto 40px; padding:0 14px; display:grid; gap:16px;
    grid-template-columns:1fr;
  }
  @media (min-width:980px){ main{grid-template-columns:2.1fr 1.4fr} }

  /* Cards */
  .card{
    background:transparent; border:1px solid var(--border);
    border-radius:0; box-shadow:var(--shadow); overflow:hidden;
  }
  .card h2{
    margin:0; padding:14px 16px; font-family:'Cinzel Decorative',cursive; font-size:18px;
    letter-spacing:.3px; font-weight:700; border-bottom:1px solid var(--border);
    color:var(--cor-arcana); background:transparent; text-shadow:0 0 10px var(--cor-arcana);
  }
  .card .body{padding:14px;}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .row>*{flex:1}
  .control{display:flex; flex-direction:column; gap:6px; min-width:200px}
  label{font-size:12px; color:var(--muted)}

  select,input[type="number"],button,.btn{
    appearance:none; border:1px solid var(--cor-arcana); background:#000; color:#fff; border-radius:0;
    padding:10px 12px; font-size:14px; font-family:'MedievalSharp',cursive; outline:none;
    transition:box-shadow .3s,border-color .3s,color .3s;
  }
  select:focus,input[type="number"]:focus,button:focus,.btn:focus{border-color:#fff; box-shadow:var(--cor-arcana-glow)}
  button,.btn{cursor:pointer}
  button:hover,.btn:hover{border-color:#fff; color:#fff; box-shadow:var(--cor-arcana-glow)}

  .grid-6{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
  @media (max-width:820px){ .grid-6{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:520px){ .grid-6{grid-template-columns:repeat(2,1fr)} }

  .stat{
    background:transparent; border:1px solid var(--border); border-radius:0; padding:10px;
    display:grid; gap:8px; grid-template-rows:auto auto auto;
  }
  .stat h3{margin:0; font-size:12px; color:var(--muted); text-align:center; letter-spacing:.5px; font-family:'Cinzel Decorative',cursive;}
  .stat .val{display:flex; align-items:center; justify-content:center; gap:8px}
  .n{font-size:24px; font-weight:700; min-width:40px; text-align:center}
  .btn-ghost{
    border:1px solid var(--muted); background:transparent; color:var(--muted); border-radius:0;
    font-weight:700; width:36px; height:32px; font-family:sans-serif;
  }
  .btn-ghost:hover:not(:disabled){color:#fff; border-color:var(--cor-arcana); box-shadow:0 0 5px var(--cor-arcana)}
  .btn-ghost:disabled{opacity:.4}
  .meta{display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}
  .cost-badge{padding:2px 8px; border-radius:0; background:transparent; border:1px solid var(--border)}
  .cost-badge.spend{color:#fff} .cost-badge.gain{color:var(--gain)}
  .warning{color:var(--danger); font-weight:600} .ok{color:var(--ok); font-weight:600}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:0; background:transparent; border:1px solid var(--cor-arcana); font-size:12px}
  .split{display:grid; gap:12px} @media(min-width:720px){ .split{grid-template-columns:1.4fr 1fr} }
  .totals{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  table{width:100%; border-collapse:collapse; font-size:13px; background:transparent; border-radius:0; overflow:hidden}
  th,td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:center}
  th{font-weight:700; color:var(--cor-arcana); background:transparent; font-family:'Cinzel Decorative',cursive;}
  tfoot td{background:transparent; font-weight:700}
  .muted{color:var(--muted)}
  .bar{height:8px; background:transparent; border:1px solid var(--cor-arcana); border-radius:0; overflow:hidden}
  .bar>i{display:block; height:100%; width:0%; background:var(--cor-arcana)}
  .hint{font-size:12px; color:var(--muted)}
  .footer-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .primary{background:var(--cor-arcana); color:#000; border:1px solid var(--cor-arcana); font-weight:800; font-family:'Cinzel Decorative',cursive;}
  .primary:hover{background:#fff; color:#000; border-color:#fff; box-shadow:none}
  .outline{background:transparent; border:1px solid var(--cor-arcana)}
  .rune-extra{display:none; gap:10px; margin-top:10px}
  .rune-extra.show{display:flex}
  .danger{color:#ff7b94}

  /* Intro: Selo + Flash */
  #seal-container{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:240px; height:240px; cursor:pointer; z-index:20; transition:opacity .45s ease;
  }
  #flash{position:fixed; inset:0; background:var(--cor-arcana); z-index:99; opacity:0; pointer-events:none}
  #flash.run{animation:flash-bang .6s ease-out forwards}
  @keyframes flash-bang{0%{opacity:0}10%{opacity:1}45%{opacity:.92}100%{opacity:0}}
  @keyframes pulse-arcano{
    0%,100%{ text-shadow:0 0 6px #fff,0 0 12px var(--cor-arcana),0 0 18px var(--cor-arcana)}
    50%{ text-shadow:0 0 10px #fff,0 0 22px var(--cor-arcana),0 0 32px var(--cor-arcana),0 0 45px var(--cor-arcana)}
  }

  /* SVG Seal Animations (A1 geomÃ©trico, B2 respiraÃ§Ã£o) */
  #arcane-seal-svg{width:100%; height:100%}
  .g-outer{animation:breath 3.2s ease-in-out infinite}
  .g-ring{animation:rotate-slow 120s linear infinite}
  .dash{stroke-dasharray:6 10; animation:dash-move 6s linear infinite}
  .pulse-stroke{animation:stroke-pulse 2.8s ease-in-out infinite}
  .glow { filter:url(#glow); }
  @keyframes breath{0%{transform:scale(.965)}50%{transform:scale(1)}100%{transform:scale(.965)}}
  @keyframes rotate-slow{to{transform:rotate(360deg)}}
  @keyframes dash-move{to{stroke-dashoffset:-160}}
  @keyframes stroke-pulse{
    0%,100%{stroke:#b24cff; stroke-opacity:.95}
    50%{stroke:#d8b6ff; stroke-opacity:1}
  }

  /* Reveal content after click */
  #main-header,#main-content{display:none; opacity:0; transition:opacity .6s ease}
  #main-header.show,#main-content.show{display:block; opacity:1}
  @media (min-width:980px){ #main-content.show{display:grid} }
</style>
</head>
<body>

<!-- SELO SVG COMPLEXO -->
<div id="seal-container" aria-label="Ativar Selo Arcano">
  <svg id="arcane-seal-svg" viewBox="0 0 240 240" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="b1"/>
        <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="b2"/>
        <feMerge>
          <feMergeNode in="b2"/>
          <feMergeNode in="b1"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#b24cff"/>
        <stop offset="100%" stop-color="#d8b6ff"/>
      </linearGradient>
    </defs>

    <!-- Outer breathing group -->
    <g class="g-outer glow" transform-origin="120 120">
      <!-- Outer rings -->
      <circle cx="120" cy="120" r="110" fill="none" stroke="url(#rg)" stroke-width="1.5" class="pulse-stroke"/>
      <circle cx="120" cy="120" r="104" fill="none" stroke="#b24cff" stroke-opacity=".7" stroke-width="1.2" class="dash"/>

      <!-- Triangular star (hexagram-like) -->
      <g stroke="#b24cff" stroke-width="1.2" fill="none" class="g-ring" transform-origin="120 120">
        <polygon points="120,32 176,168 64,168" />
        <polygon points="120,208 64,72 176,72" />
      </g>

      <!-- Inner circle -->
      <circle cx="120" cy="120" r="72" fill="none" stroke="#b24cff" stroke-width="1.2" class="pulse-stroke"/>
      <circle cx="120" cy="120" r="68" fill="none" stroke="#b24cff" stroke-opacity=".7" stroke-width="0.9" class="dash"/>

      <!-- Radial spokes -->
      <g stroke="#d8b6ff" stroke-width="0.8" opacity=".85">
        <line x1="120" y1="46" x2="120" y2="70"/>
        <line x1="120" y1="170" x2="120" y2="194"/>
        <line x1="46" y1="120" x2="70" y2="120"/>
        <line x1="170" y1="120" x2="194" y2="120"/>
        <line x1="76" y1="76" x2="92" y2="92"/>
        <line x1="148" y1="148" x2="164" y2="164"/>
        <line x1="148" y1="92" x2="164" y2="76"/>
        <line x1="76" y1="164" x2="92" y2="148"/>
      </g>

      <!-- Glyph ring (geometric runes) -->
      <g class="g-ring" transform-origin="120 120">
        <!-- 24 tiny triangles as glyphs -->
        <!-- placed at 24-step rotations -->
        <!-- we build 12 and mirror with rotate 15deg offset -->
        <g fill="#b24cff" opacity=".88">
          <!-- 12 -->
          <g transform="translate(120 120)">
            <g transform="rotate(0) translate(0 -90)">
              <polygon points="-2,0 2,0 0,-6"/>
            </g>
            <g transform="rotate(30) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(60) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(90) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(120) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(150) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(180) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(210) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(240) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(270) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(300) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
            <g transform="rotate(330) translate(0 -90)"><polygon points="-2,0 2,0 0,-6"/></g>
          </g>
          <!-- 12 offset -->
          <g transform="translate(120 120) rotate(15)">
            <g transform="rotate(0) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(30) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(60) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(90) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(120) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(150) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(180) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(210) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(240) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(270) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(300) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
            <g transform="rotate(330) translate(0 -90)"><polygon points="-1.4,0 1.4,0 0,-4.5"/></g>
          </g>
        </g>
      </g>

      <!-- Inner sigil (triangle + circle) -->
      <g stroke="#b24cff" stroke-width="1.1" fill="none">
        <polygon points="120,86 148,140 92,140" class="pulse-stroke"/>
        <circle cx="120" cy="122" r="10" />
        <line x1="120" y1="112" x2="120" y2="132" />
        <line x1="110" y1="127" x2="130" y2="127" />
      </g>
    </g>
  </svg>
</div>

<div id="flash"></div>

<header id="main-header">
  <h1>Calculadora Point Buy â€” D&D 5e (27 pontos) + Runas</h1>
  <p>Distribua 27 pontos (prÃ©-runa <strong>4â€“15</strong>). Abaixo de 8 devolve pontos. Acima de 15 Ã© invÃ¡lido antes da runa.</p>
</header>

<main id="main-content">
  <section class="card">
    <h2>ConfiguraÃ§Ã£o</h2>
    <div class="body split">
      <div class="left">
        <div class="row">
          <div class="control">
            <label>Classe</label>
            <select id="cls"></select>
          </div>
          <div class="control">
            <label>Subclasse</label>
            <select id="subcls"></select>
          </div>
        </div>

        <div class="row">
          <div class="control">
            <label>Runa</label>
            <select id="rune"></select>
          </div>
          <div id="runeExtras" class="rune-extra">
            <div class="control" id="runeChoice1Wrap">
              <label>Escolha de atributo (runa)</label>
              <select id="runeChoice1"></select>
            </div>
            <div class="control" id="runeChoice2Wrap">
              <label>2Âª escolha (Runa da Entropia)</label>
              <select id="runeChoice2"></select>
            </div>
          </div>
        </div>

        <div class="totals" style="margin-top:6px;">
          <span class="pill">Pontos restantes: <strong id="ptsLeft">27</strong> / 27</span>
          <span class="pill">Custo total (gastos â€“ ganhos): <strong id="costTotal">0</strong></span>
          <span class="pill">PrÃ©-runa vÃ¡lido: <strong id="validPB" class="ok">Sim</strong></span>
        </div>

        <div class="hint" style="margin-top:8px">
          <strong>Tabela 4â€“15:</strong> 4=-4, 5=-3, 6=-2, 7=-1, 8=0, 9=1, 10=2, 11=3, 12=4, 13=5, 14=7, 15=9.
        </div>
      </div>

      <div class="right">
        <div class="control">
          <label>Progresso de compra (0 a 27)</label>
          <div class="bar"><i id="bar"></i></div>
        </div>
        <div class="footer-actions">
          <button class="btn outline" id="reset">Zerar (8 em tudo)</button>
          <button class="btn primary" id="export">Exportar Build (JSON)</button>
          <label class="btn outline" style="cursor:pointer">
            Importar Build
            <input type="file" id="import" accept="application/json" style="display:none">
          </label>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Atributos (prÃ©-runa)</h2>
    <div class="body">
      <div class="grid-6" id="statsGrid"></div>
      <div class="hint" style="margin-top:6px">Permitido: 4â€“15 antes de aplicar a Runa. Custo negativo significa que vocÃª ganhou pontos.</div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>Resultado Final (apÃ³s Runa)</h2>
    <div class="body">
      <div class="row" style="align-items:flex-end;">
        <div class="control">
          <label>Resumo</label>
          <div id="summary" class="pill" style="width:100%; justify-content:space-between">
            <span id="sumText" class="muted">â€”</span>
            <span id="warnings" class="danger"></span>
          </div>
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Atributo</th>
              <th>PrÃ©-Runa</th>
              <th>BÃ´nus da Runa</th>
              <th>PÃ³s-Runa</th>
              <th>Mod</th>
            </tr>
          </thead>
          <tbody id="finalTable"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align:left">
                <span class="muted">Avisos:</span>
                <span id="capWarn" class="danger"></span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
/* ------------------------------ DATA ------------------------------ */
const ATTRS=["ForÃ§a","Destreza","ConstituiÃ§Ã£o","InteligÃªncia","Sabedoria","Carisma"];
const KEY=["str","dex","con","int","wis","cha"];
const COST={4:-4,5:-3,6:-2,7:-1,8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};
const CLASSES={
  "Barbarian":["Path of the Berserker","Path of the Totem Warrior","Path of the Ancestral Guardian","Path of the Storm Herald","Path of the Zealot","Path of the Beast","Path of Wild Magic"],
  "Bard":["College of Lore","College of Valor","College of Glamour","College of Swords","College of Whispers","College of Creation","College of Eloquence"],
  "Cleric":["Knowledge","Life","Light","Nature","Tempest","Trickery","War","Forge","Grave","Order","Peace","Twilight"],
  "Druid":["Circle of the Land","Circle of the Moon","Circle of Dreams","Circle of the Shepherd","Circle of Spores","Circle of Stars","Circle of Wildfire"],
  "Fighter":["Champion","Battle Master","Eldritch Knight","Arcane Archer","Cavalier","Samurai","Psi Warrior","Rune Knight","Echo Knight"],
  "Monk":["Way of the Open Hand","Way of Shadow","Way of the Four Elements","Sun Soul","Kensei","Drunken Master","Mercy","Astral Self"],
  "Paladin":["Oath of Devotion","Oath of the Ancients","Oath of Vengeance","Oath of Conquest","Oath of Redemption","Oath of Glory","Oath of the Watchers"],
  "Ranger":["Hunter","Beast Master","Gloom Stalker","Horizon Walker","Monster Slayer","Fey Wanderer","Swarmkeeper"],
  "Rogue":["Thief","Assassin","Arcane Trickster","Inquisitive","Mastermind","Scout","Swashbuckler","Phantom","Soulknife"],
  "Sorcerer":["Draconic Bloodline","Wild Magic","Divine Soul","Shadow Magic","Storm Sorcery","Aberrant Mind","Clockwork Soul"],
  "Warlock":["The Archfey","The Fiend","The Great Old One","The Celestial","The Hexblade","The Fathomless","The Genie","Undead"],
  "Wizard":["School of Abjuration","Conjuration","Divination","Enchantment","Evocation","Illusion","Necromancy","Transmutation","Bladesinging","Graviturgy","Chronurgy"],
  "Artificer":["Alchemist","Armorer","Artillerist","Battle Smith"]
};
const RUNES=[
  {id:"rust",name:"Runa da Ferrugem (+2 CON)",type:"fixed",bonus:{con:2}},
  {id:"memory",name:"Runa da LembranÃ§a (+2 SAB)",type:"fixed",bonus:{wis:2}},
  {id:"vigil",name:"Runa da VigÃ­lia (+2 DES)",type:"fixed",bonus:{dex:2}},
  {id:"scar",name:"Runa da Cicatriz (+2 FOR)",type:"fixed",bonus:{str:2}},
  {id:"echo",name:"Runa do Eco (+2 CAR)",type:"fixed",bonus:{cha:2}},
  {id:"void",name:"Runa do Vazio (+2 INT)",type:"fixed",bonus:{int:2}},
  {id:"entropy",name:"Runa da Entropia (+1 em dois atributos Ã  escolha)",type:"two",bonus:{}},
  {id:"coldflame",name:"Runa da Chama Fria (+2 CAR ou INT)",type:"one",options:["cha","int"]},
  {id:"innerbone",name:"Runa do Osso Interior (+2 SAB ou CON)",type:"one",options:["wis","con"]},
  {id:"rupture",name:"Runa da Ruptura (+2 em qualquer atributo)",type:"one-any"},
  {id:"shard",name:"Runa da FragmentaÃ§Ã£o (indisponÃ­vel)",type:"locked",bonus:{}}
];

/* ------------------------------ STATE ------------------------------ */
const state={
  base:{str:8,dex:8,con:8,int:8,wis:8,cha:8},
  cls:"Fighter", subcls:"Champion", rune:"rust",
  runeChoice1:null, runeChoice2:null
};

/* ------------------------------ DOM ------------------------------ */
const el={
  cls:document.getElementById("cls"),
  subcls:document.getElementById("subcls"),
  rune:document.getElementById("rune"),
  runeExtras:document.getElementById("runeExtras"),
  rc1Wrap:document.getElementById("runeChoice1Wrap"),
  rc2Wrap:document.getElementById("runeChoice2Wrap"),
  rc1:document.getElementById("runeChoice1"),
  rc2:document.getElementById("runeChoice2"),
  ptsLeft:document.getElementById("ptsLeft"),
  costTotal:document.getElementById("costTotal"),
  validPB:document.getElementById("validPB"),
  stats:document.getElementById("statsGrid"),
  bar:document.getElementById("bar"),
  finalTable:document.getElementById("finalTable"),
  capWarn:document.getElementById("capWarn"),
  summary:document.getElementById("sumText"),
  warnings:document.getElementById("warnings"),
  reset:document.getElementById("reset"),
  export:document.getElementById("export"),
  import:document.getElementById("import"),

  seal:document.getElementById('seal-container'),
  flash:document.getElementById('flash'),
  header:document.getElementById('main-header'),
  main:document.getElementById('main-content')
};

/* ------------------------------ UI INIT ------------------------------ */
function initClassUI(){
  el.cls.innerHTML=Object.keys(CLASSES).map(c=>`<option value="${c}">${c}</option>`).join("");
  el.cls.value=state.cls; fillSubclass();
}
function fillSubclass(){
  const subs=CLASSES[el.cls.value]||[];
  el.subcls.innerHTML=subs.map(s=>`<option value="${s}">${s}</option>`).join("");
  if(!subs.includes(state.subcls)) state.subcls=subs[0]||"";
  el.subcls.value=state.subcls;
}
function initRunes(){
  el.rune.innerHTML=RUNES.map(r=>{
    if(r.id==="shard") return `<option value="${r.id}" disabled>ðŸ”’ ${r.name}</option>`;
    return `<option value="${r.id}">${r.name}</option>`;
  }).join("");
  el.rune.value=state.rune; initRuneChoiceUI();
}
function makeAttrOptions(){ return KEY.map((k,i)=>`<option value="${k}">${ATTRS[i]}</option>`).join(""); }
function initRuneChoiceUI(){
  const r=RUNES.find(x=>x.id===el.rune.value);
  el.runeExtras.classList.remove("show");
  el.rc1Wrap.style.display="none"; el.rc2Wrap.style.display="none";
  if(!r) return;
  if(r.type==="one"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display="block";
    el.rc1.innerHTML=r.options.map(k=>`<option value="${k}">${ATTRS[KEY.indexOf(k)]}</option>`).join("");
    if(!r.options.includes(state.runeChoice1)) state.runeChoice1=r.options[0];
    el.rc1.value=state.runeChoice1;
  }else if(r.type==="one-any"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display="block";
    el.rc1.innerHTML=makeAttrOptions();
    if(!KEY.includes(state.runeChoice1)) state.runeChoice1="str";
    el.rc1.value=state.runeChoice1;
  }else if(r.type==="two"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display="block"; el.rc2Wrap.style.display="block";
    el.rc1.innerHTML=makeAttrOptions(); el.rc2.innerHTML=makeAttrOptions();
    if(!KEY.includes(state.runeChoice1)||state.runeChoice1==null) state.runeChoice1="str";
    if(!KEY.includes(state.runeChoice2)||state.runeChoice2==null) state.runeChoice2="dex";
    el.rc1.value=state.runeChoice1; el.rc2.value=state.runeChoice2;
  }
}

/* ------------------------------ POINT BUY ------------------------------ */
function scoreCost(v){ if(v<4||v>15) return Infinity; return COST[v]; }
function totalCost(base){ return KEY.reduce((s,k)=>s+scoreCost(base[k]),0); }
function pointsLeft(base){ return 27-totalCost(base); }
function canInc(base,k){
  const v=base[k]; if(v>=15) return false;
  const hypot={...base,[k]:v+1}; return totalCost(hypot)<=27;
}
function canDec(base,k){ return base[k]>4; }

/* ------------------------------ RUNAS ------------------------------ */
function applyRune(base){
  const after={...base};
  const r=RUNES.find(x=>x.id===el.rune.value);
  let bonus={str:0,dex:0,con:0,int:0,wis:0,cha:0};
  if(!r) return {after,bonus};
  if(r.type==="fixed") bonus={...bonus,...r.bonus};
  else if(r.type==="one"||r.type==="one-any"){ if(el.rc1.value) bonus[el.rc1.value]+=2; }
  else if(r.type==="two"){ if(el.rc1.value) bonus[el.rc1.value]+=1; if(el.rc2.value) bonus[el.rc2.value]+=1; }
  KEY.forEach(k=>after[k]=base[k]+bonus[k]);
  return {after,bonus};
}
function modOf(s){ return Math.floor((s-10)/2); }

/* ------------------------------ RENDER ------------------------------ */
function renderStats(){
  el.stats.innerHTML=KEY.map((k,i)=>{
    const v=state.base[k];
    const cost=scoreCost(v);
    const badgeCls=(cost<0)?"gain":"spend";
    const costTxt=(cost>0?"+":"")+cost;
    return `
      <div class="stat" data-k="${k}">
        <h3>${ATTRS[i]}</h3>
        <div class="val">
          <button class="btn-ghost" data-act="dec" ${!canDec(state.base,k)?"disabled":""}>â€“</button>
          <div class="n">${v}</div>
          <button class="btn-ghost" data-act="inc" ${!canInc(state.base,k)?"disabled":""}>+</button>
        </div>
        <div class="meta">
          <span class="${(v<4||v>15)?"warning":""}">Limite: 4â€“15</span>
          <span class="cost-badge ${badgeCls}">Custo: ${Number.isFinite(cost)?costTxt:"â€”"}</span>
        </div>
      </div>
    `;
  }).join("");

  el.stats.querySelectorAll(".btn-ghost").forEach(btn=>{
    btn.onclick=()=>{
      const k=btn.closest(".stat").dataset.k;
      const act=btn.dataset.act;
      if(act==="inc"&&canInc(state.base,k)) state.base[k]++;
      if(act==="dec"&&canDec(state.base,k)) state.base[k]--;
      updateAll();
    };
  });
}
function renderTotals(){
  const cost=totalCost(state.base), left=pointsLeft(state.base);
  el.ptsLeft.textContent=left; el.costTotal.textContent=cost;
  el.validPB.textContent=(cost<=27)?"Sim":"NÃ£o";
  el.validPB.className=(cost<=27)?"ok":"warning";
  el.bar.style.width=Math.round((Math.min(27,Math.max(0,cost))/27)*100)+"%";
}
function renderResult(){
  const {after,bonus}=applyRune(state.base);
  let capWarn=[]; let anyWarn=false;
  el.finalTable.innerHTML=KEY.map((k,i)=>{
    const pre=state.base[k], bn=bonus[k]||0, post=after[k];
    if(post>20){ capWarn.push(`${ATTRS[i]} ${post} (>20)`); anyWarn=true;}
    const m=modOf(post);
    return `<tr>
      <td style="text-align:left">${ATTRS[i]}</td>
      <td>${pre}</td><td>${bn>=0?`+${bn}`:bn}</td><td>${post}</td><td>${m>=0?`+${m}`:m}</td>
    </tr>`;
  }).join("");
  el.capWarn.textContent=capWarn.length?`Limite 20 excedido em: ${capWarn.join(", ")}`:"â€”";
  const runeName=(RUNES.find(r=>r.id===el.rune.value)||{}).name||"â€”";
  el.summary.textContent=`Classe: ${el.cls.value} â€” Subclasse: ${el.subcls.value} â€” Runa: ${runeName}`;
  el.warnings.textContent=anyWarn?"AtenÃ§Ã£o aos limites de 20.":"";
}

/* ------------------------------ UPDATE ------------------------------ */
function updateAll(){ renderStats(); renderTotals(); renderResult(); }

/* ------------------------------ EXPORT/IMPORT ------------------------------ */
function exportBuild(){
  const data={base:state.base,cls:el.cls.value,subcls:el.subcls.value,rune:el.rune.value,
    runeChoice1:el.rc1?.value??null,runeChoice2:el.rc2?.value??null};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="build-pointbuy.json"; a.click();
  URL.revokeObjectURL(a.href);
}
function importBuild(file){
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const j=JSON.parse(fr.result);
      if(j.base) state.base={...state.base,...j.base};
      if(j.cls){ state.cls=j.cls; el.cls.value=j.cls; fillSubclass(); }
      if(j.subcls){ state.subcls=j.subcls; el.subcls.value=j.subcls; }
      if(j.rune){ state.rune=j.rune; el.rune.value=j.rune; }
      if(j.runeChoice1) state.runeChoice1=j.runeChoice1;
      if(j.runeChoice2) state.runeChoice2=j.runeChoice2;
      initRuneChoiceUI(); updateAll();
    }catch(e){ alert("JSON invÃ¡lido."); }
  };
  fr.readAsText(file);
}

/* ------------------------------ EVENTS ------------------------------ */
el.cls.onchange=()=>{ state.cls=el.cls.value; fillSubclass(); updateAll(); };
el.subcls.onchange=()=>{ state.subcls=el.subcls.value; updateAll(); };
el.rune.onchange=()=>{ state.rune=el.rune.value; initRuneChoiceUI(); updateAll(); };
document.addEventListener("change",(e)=>{
  if(e.target===el.rc1){ state.runeChoice1=el.rc1.value; updateAll(); }
  if(e.target===el.rc2){ state.runeChoice2=el.rc2.value; updateAll(); }
});
el.reset.onclick=()=>{ KEY.forEach(k=>state.base[k]=8); updateAll(); };
el.export.onclick=exportBuild;
el.import.onchange=(e)=>{ if(e.target.files[0]) importBuild(e.target.files[0]); };

/* ------------------------------ INTRO: CLICK SEAL -> SOUND+FLASH+REVEAL ------------------------------ */
let audioCtx=null;
function ensureAudioCtx(){
  if(audioCtx) return audioCtx;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}

/* C3: pulso de energia + particulado arcano (granular/noise + pitch drop) */
function playArcaneBurst(){
  const ctx=ensureAudioCtx();
  // Master Gain
  const master=ctx.createGain(); master.gain.value=0.0; master.connect(ctx.destination);

  // Compressor para segurar o pico
  const comp=ctx.createDynamicsCompressor();
  comp.threshold.setValueAtTime(-18, ctx.currentTime);
  comp.knee.setValueAtTime(20, ctx.currentTime);
  comp.ratio.setValueAtTime(6, ctx.currentTime);
  comp.attack.setValueAtTime(0.003, ctx.currentTime);
  comp.release.setValueAtTime(0.25, ctx.currentTime);
  comp.connect(master);

  // 1) RuÃ­do granular (grÃ£os curtÃ­ssimos) com bandpass ressonante
  const noiseBuf=ctx.createBuffer(1, ctx.sampleRate*1.2, ctx.sampleRate);
  const data=noiseBuf.getChannelData(0);
  for(let i=0;i<data.length;i++){
    // ligeiro pink-ish
    const w=Math.random()*2-1;
    data[i]= (data[i-1]||0)*0.98 + w*0.06;
  }
  const noise=ctx.createBufferSource(); noise.buffer=noiseBuf; noise.loop=false;

  const bp=ctx.createBiquadFilter(); bp.type="bandpass";
  bp.frequency.setValueAtTime(600, ctx.currentTime);
  bp.Q.setValueAtTime(10, ctx.currentTime);

  // sweep de ressonÃ¢ncia
  bp.frequency.exponentialRampToValueAtTime(180, ctx.currentTime+0.8);

  // grÃ£o tremido via ganho
  const noiseGain=ctx.createGain(); noiseGain.gain.setValueAtTime(0.0, ctx.currentTime);
  noise.connect(bp).connect(noiseGain).connect(comp);

  // 2) Osc down-sweep (pitch drop)
  const osc=ctx.createOscillator();
  osc.type="triangle"; osc.frequency.setValueAtTime(220, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(48, ctx.currentTime+0.9);

  const oscGain=ctx.createGain(); oscGain.gain.setValueAtTime(0.0, ctx.currentTime);
  osc.connect(oscGain).connect(comp);

  // 3) Pequenas faÃ­scas (clicks filtrados)
  const spark=ctx.createOscillator(); spark.type="square"; spark.frequency.setValueAtTime(1200, ctx.currentTime);
  const sparkGain=ctx.createGain(); sparkGain.gain.value=0; spark.connect(sparkGain).connect(comp);
  spark.frequency.exponentialRampToValueAtTime(300, ctx.currentTime+0.18);

  // Envelope master (explosÃ£o + cauda)
  const now=ctx.currentTime;
  master.gain.linearRampToValueAtTime(0.9, now+0.04);
  master.gain.exponentialRampToValueAtTime(0.4, now+0.2);
  master.gain.exponentialRampToValueAtTime(0.12, now+0.6);
  master.gain.exponentialRampToValueAtTime(0.001, now+1.2);

  // Envelopes internos
  noiseGain.gain.linearRampToValueAtTime(0.8, now+0.03);
  noiseGain.gain.exponentialRampToValueAtTime(0.12, now+0.6);
  noiseGain.gain.exponentialRampToValueAtTime(0.001, now+1.1);

  oscGain.gain.linearRampToValueAtTime(0.6, now+0.04);
  oscGain.gain.exponentialRampToValueAtTime(0.08, now+0.7);
  oscGain.gain.exponentialRampToValueAtTime(0.0008, now+1.1);

  // Sparks curtos
  sparkGain.gain.setValueAtTime(0.0, now);
  sparkGain.gain.linearRampToValueAtTime(0.15, now+0.02);
  sparkGain.gain.exponentialRampToValueAtTime(0.0001, now+0.15);

  noise.start(now);
  osc.start(now);
  spark.start(now);

  noise.stop(now+1.25);
  osc.stop(now+1.25);
  spark.stop(now+0.2);
}

function revealUI(){
  el.header.classList.add('show');
  el.main.classList.add('show');
}

(function intro(){
  el.seal.addEventListener('click', async ()=>{
    try{ ensureAudioCtx().resume(); }catch(e){}
    // som
    playArcaneBurst();
    // flash
    el.flash.classList.add('run');
    // fade selo
    el.seal.style.opacity='0';
    setTimeout(()=>{ try{ el.seal.remove(); }catch(e){}; revealUI(); }, 500);
  }, {once:true});
})();

/* ------------------------------ BOOT ------------------------------ */
(function boot(){
  initClassUI(); initRunes(); updateAll();
})();
</script>
</body>
</html>

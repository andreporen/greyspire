<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sensorium ‚Äî Selo, Carta & Calculadora</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#f3e9cf; --ink-dim:#cabf9d;
    --purple:#b24cff; --purple-deep:#3C0061;
    --muted:#a9a8a5; --danger:#ff4d6d;
    --bg:#000; --panel:rgba(10,8,12,.45);
    --border:rgba(178,76,255,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 10% 0%, rgba(178,76,255,0.06), transparent 60%),
      radial-gradient(1000px 600px at 90% 10%, rgba(60,0,97,0.08), transparent 60%),
      radial-gradient(1600px 1000px at 50% 100%, rgba(178,76,255,0.05), transparent 60%),
      repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 2px),
      #000;
    font-family:'MedievalSharp', cursive;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:1;
    background:
      radial-gradient(1000px 600px at 50% 10%, rgba(0,0,0,0.2), transparent 70%),
      linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.4));
    mix-blend-mode:multiply;
  }

  /* ---------- FLASH ---------- */
  #flash{ position:fixed; inset:0; background:var(--purple); opacity:0; pointer-events:none; z-index:30 }
  .flash-run{ animation:flash .55s ease-out forwards }
  @keyframes flash{ 0%{opacity:0} 10%{opacity:1} 40%{opacity:.9} 100%{opacity:0} }

  /* ---------- SELO "A" SVG (complexo) ---------- */
  #seal-container{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:260px; height:260px; z-index:20; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition:opacity .45s ease-out;
  }
  /* --- ATUALIZADO --- */
  .seal-svg{ 
    width:100%; height:100%; 
    filter:drop-shadow(0 0 22px rgba(178,76,255,.55)); 
    display:block;
  }
  /* --- FIM DA ATUALIZA√á√ÉO --- */
  .seal-pulse{ animation:sealPulse 2.8s ease-in-out infinite }
  .ring-rot{ animation:ringRot 18s linear infinite }
  .sigil-rot{ animation:sigilRot 36s linear infinite }
  .shine{ animation:shine 3.2s ease-in-out infinite; opacity:.9 }
  .strobe{ animation:strobe 4.6s ease-in-out infinite }
  #seal-container:hover .seal-svg{ filter:drop-shadow(0 0 26px rgba(178,76,255,.8)) }
  .seal-hide{ opacity:0 !important; filter:drop-shadow(0 0 6px rgba(178,76,255,.2)) }

  @keyframes sealPulse{ 0%,100%{ transform:scale(.965) } 50%{ transform:scale(1) } }
  @keyframes ringRot{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  @keyframes sigilRot{ from{transform:rotate(0deg)} to{transform:rotate(-360deg)} }
  @keyframes shine{
    0%,100%{ filter:brightness(1) drop-shadow(0 0 8px #b24cff) }
    50%{ filter:brightness(1.15) drop-shadow(0 0 18px #b24cff) }
  }
  @keyframes strobe{
    0%,92%{ opacity:1 } 94%{ opacity:.5 } 96%{ opacity:.9 } 98%{opacity:.4} 100%{opacity:1}
  }

  /* ---------- CARTA ---------- */
  #carta-stage{ display:none; opacity:0; transition:opacity .8s ease; position:relative; z-index:2; }
  #carta-wrap{
    max-width:900px; margin:8vh auto 4vh; padding:28px 22px;
    background: var(--panel);
    border:1px solid var(--border);
    box-shadow: 0 0 24px rgba(178,76,255,.18), inset 0 0 60px rgba(178,76,255,.05);
    position:relative; overflow:hidden;
  }
  #carta-wrap::before{
    content:""; position:absolute; inset:-12px;
    background:
      radial-gradient(300px 140px at 0% 0%, rgba(0,0,0,0.8), transparent 70%),
      radial-gradient(380px 180px at 100% 20%, rgba(0,0,0,0.7), transparent 70%),
      radial-gradient(420px 180px at 0% 100%, rgba(0,0,0,0.75), transparent 70%),
      radial-gradient(300px 160px at 100% 100%, rgba(0,0,0,0.85), transparent 70%);
    mix-blend-mode:multiply; pointer-events:none;
  }
  #carta h1{
    font-family:'Cinzel Decorative', cursive; color:var(--purple); margin:0 0 14px 0;
    font-size:clamp(20px,3.6vw,28px); letter-spacing:.5px; text-shadow:0 0 12px rgba(178,76,255,.6);
  }
  #carta p{ line-height:1.6; color:var(--ink); margin:10px 0 }
  #carta em{ color:var(--ink-dim) }
  .actions{ margin-top:20px; display:flex; flex-wrap:wrap; gap:10px }
  .btn{
    appearance:none; border:1px solid var(--purple); background:#000; color:#fff;
    padding:10px 14px; cursor:pointer; font-family:'Cinzel Decorative', cursive;
    box-shadow:0 0 18px rgba(178,76,255,.18); letter-spacing:.3px;
    transition:box-shadow .3s, border-color .3s, transform .2s;
  }
  .btn:hover{ border-color:#fff; box-shadow:0 0 22px rgba(178,76,255,.32); transform:translateY(-1px) }

  /* Efeitos da carta */
  .blink{ animation:blink 3.6s steps(1,end) infinite }
  @keyframes blink{ 0%,87%{opacity:1} 88%{opacity:.15} 92%{opacity:.6} 96%{opacity:.3} 100%{opacity:1} }
  .fx-fade{ animation:fadePulse 6.5s ease-in-out infinite }
  @keyframes fadePulse{ 0%,100%{opacity:1} 40%{opacity:.45} 60%{opacity:.9} }
  .fx-glow{ color:#fff; text-shadow:0 0 6px #fff,0 0 14px var(--purple),0 0 26px var(--purple),0 0 42px var(--purple-deep);
            animation:glowBreath 3.4s ease-in-out infinite }
  @keyframes glowBreath{ 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.15)} }
  .fx-blur{ filter:blur(1.4px); transition:filter .35s ease }
  .fx-blur:hover{ filter:blur(0) }
  .fx-highlight{ color:#fff; text-shadow:0 0 10px var(--purple),0 0 22px var(--purple),0 0 44px var(--purple); position:relative }
  .fx-highlight::after{ content:""; position:absolute; left:-2px; right:-2px; bottom:-1px; height:1px;
    box-shadow:0 0 10px var(--purple),0 0 20px var(--purple) }
  .fx-burned{ position:relative; display:inline-block; padding:0 .1em; color:var(--ink);
    --mask: radial-gradient(8px 5px at 0% 70%, transparent 40%, black 60%) repeat-x,
            radial-gradient(6px 4px at 100% 30%, transparent 45%, black 65%) repeat-x;
    -webkit-mask: var(--mask); mask: var(--mask);
    -webkit-mask-size:18px 100%,14px 100%; mask-size:18px 100%,14px 100%;
    filter: drop-shadow(0 0 2px rgba(0,0,0,.6)) }
  .fx-missing{ display:inline-block; width:11ch; height:1em; color:transparent; position:relative; vertical-align:baseline }
  .fx-missing::before{
    content:""; position:absolute; inset:-2px -3px;
    background:
      radial-gradient(12px 7px at 12% 60%, rgba(0,0,0,0.9), transparent 70%) repeat-x,
      radial-gradient(10px 6px at 88% 40%, rgba(0,0,0,0.9), transparent 65%) repeat-x;
    filter: blur(.6px);
    -webkit-mask: radial-gradient(9px 6px at 12% 60%, black 55%, transparent 56%) repeat-x,
                  radial-gradient(8px 5px at 88% 40%, black 55%, transparent 56%) repeat-x;
    -webkit-mask-size:18px 100%,16px 100%;
    mask: radial-gradient(9px 6px at 12% 60%, black 55%, transparent 56%) repeat-x,
          radial-gradient(8px 5px at 88% 40%, black 55%, transparent 56%) repeat-x;
    mask-size:18px 100%,16px 100%;
  }
  .fx-glitch{ position:relative }
  .fx-glitch[data-glitching="1"]{ text-shadow:0 0 6px rgba(178,76,255,.9), 0 0 18px rgba(178,76,255,.6); filter:hue-rotate(10deg) saturate(1.2) }
  .fx-eaten{
    display:inline-block; position:relative; color:#fff;
    text-shadow:0 0 6px #fff,0 0 16px var(--purple),0 0 28px var(--purple);
    -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);
            mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);
    animation:eat 6.5s steps(80,end) forwards, glowBreath 3.4s ease-in-out infinite;
  }
  @keyframes eat{
    0%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);}
    70%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 70%); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 70%);}
    100%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 100%); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 100%);}
  }

  /* ---------- CALCULADORA ---------- */
  #calc-stage{ display:none; opacity:0; transition:opacity .8s ease; position:relative; z-index:2 }
  header.calc-head{ padding:18px 16px 8px; text-align:center }
  header.calc-head h1{
    margin:0; font-size:clamp(22px,3.6vw,30px); color:var(--purple);
    font-family:'Cinzel Decorative', cursive; text-shadow:0 0 12px rgba(178,76,255,.6);
  }
  header.calc-head p{ margin:6px 0 0; color:var(--muted) }
  main.calc{ max-width:1152px; margin:16px auto 40px; padding:0 14px; display:grid; gap:16px; grid-template-columns:1fr }
  @media(min-width:980px){ main.calc{ grid-template-columns:2.1fr 1.4fr } }
  .card{
    background:var(--panel); border:1px solid var(--border);
    box-shadow: 0 0 24px rgba(178,76,255,.15), inset 0 0 60px rgba(178,76,255,.05);
  }
  .card h2{
    margin:0; padding:14px 16px; font-size:18px; color:var(--purple);
    border-bottom:1px solid var(--border); font-family:'Cinzel Decorative', cursive;
  }
  .body{ padding:14px }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .control{ display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1 }
  label{ font-size:12px; color:var(--muted) }

  /* SELECTS corrigiDOS */
  select{
    -webkit-appearance:none; appearance:none;
    width:100%;
    border:1px solid var(--border);
    background: #000;
    color:#fff;
    border-radius:0;
    padding:10px 36px 10px 12px;
    font-size:14px;
    font-family:'MedievalSharp', cursive;
    outline:none;
    transition:border-color .25s, box-shadow .25s;
    background-image:
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='20' viewBox='0 0 28 20'><polyline points='6,7 14,15 22,7' fill='none' stroke='%23b24cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
    background-repeat:no-repeat; background-position:right 8px center; background-size:22px 16px;
  }
  select:focus{ border-color:#fff; box-shadow:0 0 6px #fff,0 0 12px var(--purple),0 0 18px var(--purple) }

  input[type="number"], .btn{
    border:1px solid var(--border); background:#000; color:#fff; border-radius:0; padding:10px 12px; font-size:14px
  }
  .grid-6{ display:grid; grid-template-columns:repeat(6,1fr); gap:10px }
  @media(max-width:820px){ .grid-6{ grid-template-columns:repeat(3,1fr) } }
  @media(max-width:520px){ .grid-6{ grid-template-columns:repeat(2,1fr) } }
  .stat{ border:1px solid var(--border); padding:10px }
  .stat h3{ margin:0; font-size:12px; color:var(--muted); text-align:center; letter-spacing:.5px; font-family:'Cinzel Decorative', cursive; }
  .val{ display:flex; align-items:center; justify-content:center; gap:8px }
  .n{ font-size:24px; font-weight:700; min-width:40px; text-align:center }
  .btn-ghost{ border:1px solid #7b7690; background:transparent; color:#7b7690; width:36px; height:32px; font-weight:700; font-family:sans-serif; cursor:pointer }
  .btn-ghost:hover:not(:disabled){ color:#fff; border-color:#fff }

  .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); background:transparent; border-radius:0; font-size:12px }
  .bar{height:8px; background:transparent; border:1px solid var(--border); border-radius:0; overflow:hidden}
  .bar > i{display:block; height:100%; width:0%; background:var(--purple)}
  .ok{ color:#00d38c; font-weight:600 } .warning{ color:var(--danger); font-weight:600 }
  table{ width:100%; border-collapse:collapse; font-size:13px; background:transparent }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:center }
  th{ color:var(--purple); font-family:'Cinzel Decorative', cursive }
  .rune-extra{ display:none; gap:10px; margin-top:10px }
  .rune-extra.show{ display:flex }

  /* √Åudio toggle */
  #audio-tog{ position:fixed; right:12px; bottom:12px; z-index:40; display:none }
</style>
</head>
<body>

<div id="flash"></div>

<div id="seal-container" aria-label="Ativar Selo Arcano">
  <svg class="seal-svg seal-pulse strobe" aria-hidden="true"
       viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="gPurple" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.95"/>
        <stop offset="45%" stop-color="#b24cff" stop-opacity="0.85"/>
        <stop offset="100%" stop-color="#3C0061" stop-opacity="0.0"/>
      </radialGradient>
      <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="2" result="b"/>
        <feMerge>
          <feMergeNode in="b"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>

    <circle cx="256" cy="256" r="190" fill="url(#gPurple)" opacity="0.25"/>

    <g transform="translate(256 256)">
      <g class="ring-rot">
        <circle cx="0" cy="0" r="200" fill="none" stroke="#b24cff" stroke-width="2" filter="url(#soft)"/>
        <circle cx="0" cy="0" r="206" fill="none" stroke="#b24cff" stroke-opacity=".35" stroke-width="1"/>
        <g stroke="#b24cff" stroke-linecap="round" opacity=".9">
          <g>
            <g id="tick12">
              <line x1="0" y1="-206" x2="0" y2="-196" stroke-width="2"/>
            </g>
            <use href="#tick12" transform="rotate(30)"/>
            <use href="#tick12" transform="rotate(60)"/>
            <use href="#tick12" transform="rotate(90)"/>
            <use href="#tick12" transform="rotate(120)"/>
            <use href="#tick12" transform="rotate(150)"/>
            <use href="#tick12" transform="rotate(180)"/>
            <use href="#tick12" transform="rotate(210)"/>
            <use href="#tick12" transform="rotate(240)"/>
            <use href="#tick12" transform="rotate(270)"/>
            <use href="#tick12" transform="rotate(300)"/>
            <use href="#tick12" transform="rotate(330)"/>
          </g>
        </g>
      </g>
    </g>

    <g transform="translate(256 256)">
      <g class="ring-rot" style="animation-duration: 24s;">
        <circle cx="0" cy="0" r="165" fill="none" stroke="#b24cff" stroke-opacity=".6" stroke-width="1"/>
        <g font-family="Cinzel Decorative, serif" font-size="22" fill="#ffffff">
          <g>
            <g text-anchor="middle">
              <text x="0" y="-165">·ö†</text>
              <text x="82" y="-144" transform="rotate(25)">·ö¶</text>
              <text x="139" y="-80" transform="rotate(55)">·õá</text>
              <text x="165" y="0" transform="rotate(90)">·õü</text>
              <text x="139" y="80" transform="rotate(125)">‚ú∂</text>
              <text x="82" y="144" transform="rotate(155)">·õó</text>
              <text x="0" y="165" transform="rotate(180)">‚óá</text>
              <text x="-82" y="144" transform="rotate(205)">·õâ</text>
              <text x="-139" y="80" transform="rotate(235)">‚ú∑</text>
              <text x="-165" y="0" transform="rotate(270)">·õö</text>
              <text x="-139" y="-80" transform="rotate(305)">·ö®</text>
              <text x="-82" y="-144" transform="rotate(335)">‚úß</text>
            </g>
          </g>
        </g>
      </g>
    </g>

    <g class="shine">
      <circle cx="256" cy="256" r="122" fill="none" stroke="#b24cff" stroke-width="1.6" opacity=".85"/>
      <g transform="translate(256 256)">
        <g class="sigil-rot" stroke="#b24cff" stroke-width="1.4" opacity=".9">
          <polygon points="0,-100 86,50 -86,50" fill="none"/>
          <line x1="0" y1="-100" x2="0" y2="68"/>
          <line x1="-86" y1="50" x2="86" y2="50"/>
          <circle cx="0" cy="0" r="26" fill="none"/>
          <circle cx="0" cy="0" r="3" fill="#ffffff"/>
        </g>
      </g>
    </g>

    <circle cx="256" cy="256" r="90" fill="none" stroke="#ffffff" stroke-opacity=".85" stroke-width="0.8"/>
  </svg>
</div>

<section id="carta-stage">
  <div id="carta-wrap">
    <div id="carta"></div>
    <div class="actions">
      <button class="btn" id="btn-prosseguir">Prosseguir √† calculadora</button>
    </div>
  </div>
</section>

<section id="calc-stage">
  <header class="calc-head">
    <h1>Calculadora Point Buy ‚Äî D&D 5e (27 pontos) + Runas</h1>
    <p>Distribua 27 pontos (pr√©-runa <strong>4‚Äì15</strong>). Abaixo de 8 devolve pontos. Acima de 15 √© inv√°lido antes da runa.</p>
  </header>

  <main class="calc">
    <section class="card">
      <h2>Configura√ß√£o</h2>
      <div class="body" style="display:grid; gap:12px; grid-template-columns:1fr;">
        <div class="row">
          <div class="control">
            <label>Classe</label>
            <select id="cls"></select>
          </div>
          <div class="control">
            <label>Subclasse</label>
            <select id="subcls"></select>
          </div>
        </div>

        <div class="row">
          <div class="control">
            <label>Runa</label>
            <select id="rune"></select>
          </div>
          <div id="runeExtras" class="rune-extra">
            <div class="control" id="runeChoice1Wrap">
              <label>Escolha de atributo (runa)</label>
              <select id="runeChoice1"></select>
            </div>
            <div class="control" id="runeChoice2Wrap">
              <label>2¬™ escolha (Runa da Entropia)</label>
              <select id="runeChoice2"></select>
            </div>
          </div>
        </div>

        <div class="row">
          <span class="pill">Pontos restantes: <strong id="ptsLeft">27</strong> / 27</span>
          <span class="pill">Custo total (gastos ‚Äì ganhos): <strong id="costTotal">0</strong></span>
          <span class="pill">Pr√©-runa v√°lido: <strong id="validPB" class="ok">Sim</strong></span>
        </div>
        <div class="control">
          <label>Progresso de compra (0 a 27)</label>
          <div class="bar"><i id="bar"></i></div>
        </div>
        <div class="actions">
          <button class="btn" id="reset">Zerar (8 em tudo)</button>
          <button class="btn" id="export">Exportar Build (JSON)</button>
          <label class="btn" style="cursor:pointer">Importar
            <input type="file" id="import" accept="application/json" style="display:none">
          </label>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Atributos (pr√©-runa)</h2>
      <div class="body">
        <div class="grid-6" id="statsGrid"></div>
        <div class="hint" style="margin-top:6px; color:var(--muted)">Permitido: 4‚Äì15 antes de aplicar a Runa. Custo negativo significa que voc√™ ganhou pontos.</div>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <h2>Resultado Final (ap√≥s Runa)</h2>
      <div class="body">
        <div class="row" style="align-items:flex-end;">
          <div class="control" style="width:100%">
            <label>Resumo</label>
            <div id="summary" class="pill" style="width:100%; justify-content:space-between">
              <span id="sumText" class="muted">‚Äî</span>
              <span id="warnings" style="color:var(--danger)"></span>
            </div>
          </div>
        </div>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Atributo</th><th>Pr√©-Runa</th><th>B√¥nus da Runa</th><th>P√≥s-Runa</th><th>Mod</th>
              </tr>
            </thead>
            <tbody id="finalTable"></tbody>
            <tfoot>
              <tr>
                <td colspan="5" style="text-align:left">
                  <span class="muted">Avisos:</span> <span id="capWarn" style="color:var(--danger)"></span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </main>
</section>

<button id="audio-tog" class="btn">Som: ligado</button>

<script>
/* =================== SELO: clique + flash + mostrar carta =================== */
const seal = document.getElementById('seal-container');
const flashEl = document.getElementById('flash');
const cartaStage = document.getElementById('carta-stage');
const calcStage  = document.getElementById('calc-stage');
const audioTog   = document.getElementById('audio-tog');

seal.addEventListener('click', ()=>{
  // Flash
  flashEl.classList.remove('flash-run'); void flashEl.offsetWidth; flashEl.classList.add('flash-run');
  // Selo some
  seal.classList.add('seal-hide');
  setTimeout(()=>{ seal.remove(); }, 420);
  // Audio start
  try{ ensureAudio().resume(); }catch(e){}
  startAmbient();
  audioTog.style.display='block';
  // Mostrar carta
  cartaStage.style.display='block';
  requestAnimationFrame(()=> cartaStage.style.opacity = 1);
}, {once:true});

/* =================== √ÅUDIO PROCEDURAL (sem assets) =================== */
let audioCtx, ambientGain, ambient;
function ensureAudio(){ if(audioCtx) return audioCtx; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function startAmbient(){
  const ctx = ensureAudio();
  const master = ctx.createGain(); master.gain.value = 0.0001; master.connect(ctx.destination);
  ambientGain = master;

  // Ru√≠do filtrado (motor arcano)
  const len = ctx.sampleRate*2;
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const d = buf.getChannelData(0); let prev=0;
  for(let i=0;i<d.length;i++){ const w=Math.random()*2-1; prev = prev*0.97 + w*0.03; d[i]=prev*0.7; }
  const noise = ctx.createBufferSource(); noise.buffer=buf; noise.loop=true;
  const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=360; bp.Q.value=3.2;
  const g = ctx.createGain(); g.gain.value=0.09;

  // Droning grave (sensorium)
  const osc=ctx.createOscillator(); osc.type='sawtooth'; osc.frequency.value=52;
  const low=ctx.createBiquadFilter(); low.type='lowpass'; low.frequency.value=140;
  const g2 = ctx.createGain(); g2.gain.value=0.018;

  // LFO leve para respirar
  const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.28;
  const lfoG=ctx.createGain(); lfoG.gain.value=0.07;
  lfo.connect(lfoG).connect(g.gain);

  noise.connect(bp).connect(g).connect(master);
  osc.connect(low).connect(g2).connect(master);

  noise.start(); osc.start(); lfo.start();
  ambient = {noise,osc,lfo};
  ambientGain.gain.linearRampToValueAtTime(0.35, ctx.currentTime+1.1);
}
function stopAmbient(){
  if(!audioCtx || !ambient) return;
  const t=audioCtx.currentTime;
  ambientGain.gain.linearRampToValueAtTime(0.0001, t+0.6);
  setTimeout(()=>{ try{ambient.noise.stop();ambient.osc.stop();ambient.lfo.stop();}catch(e){} },700);
}
audioTog.addEventListener('click', ()=>{
  if(!audioCtx || (ambientGain && ambientGain.gain.value<0.001)){ startAmbient(); audioTog.textContent='Som: ligado'; }
  else { stopAmbient(); audioTog.textContent='Som: desligado'; }
});

/* =================== CARTA: parser de tags + glitches =================== */
const RAW_TEXT = `
[fade]N√£o sei quanto tempo me resta antes de n√£o restar tempo algum.[/fade] J√° sinto o meu nome se afastando de mim como um dente morto empurrado pela l√≠ngua. Se lerem isto, n√£o procurem quem escreveu. O que sobra de mim j√° n√£o √© pessoa, mas ru√≠do.

[glitch]A Engrenagem est√° acelerando.[/glitch] Isso n√£o √© met√°fora. H√° algo que ela n√£o consegue mais conter, e a Liturgia sabe, mesmo que finja medir tudo com gr√°ficos e rezas. N√£o √© verdade que ela apenas drena o que enlouqueceria os cidad√£os. [fade]Ela come√ßou a drenar o que os faz lembrar que ainda s√£o humanos.[/fade]

Eu fui parte disso. Eu recitei as f√≥rmulas. Eu acreditei que manter a cidade s√£ era um bem maior. S√≥ agora percebo que existem formas de loucura mais honestas do que a ordem que impomos. A cada rota√ß√£o:

[glow-purple]uma emo√ß√£o √© apagada[/glow-purple]  
[glow-purple]uma mem√≥ria √© dilu√≠da[/glow-purple]  
[glow-purple]um rosto √© removido do mundo[/glow-purple]

[blur]Eu j√° n√£o lembro quem eram meus pais.[/blur]  
Ontem, acho que ainda lembrava.  
Agora s√≥ sei que um dia reconheci a palavra ‚Äúm√£e‚Äù como algo meu, e ela me soa estrangeira.

N√£o esperem que Œ∑ cidade grite quando come√ßar a morrer. Ela vai sorrir. Ela vai agradecer. √â o que acontece quando se esquece o que se perdeu.

Algu√©m precisa descer at√© onde a Engrenagem respira. Algu√©m que ainda possa ser lembrado. Eu n√£o posso mais. [glitch]Estou sendo reescrita enquanto escrevo.[/glitch]

Se sentirem a cabe√ßa pesar, n√£o √© culpa de voc√™s. √â ela. A m√°quina tentando transformar suas mentes em arquivo apag√°vel. Resistam. Repitam o pr√≥prio nome. Lembrem-se das m√£os. Lembrem-se do que escolheram ser antes de a cidade escolher por voc√™s.

[glow-purple]O sensorium est√° oscilando.[/glow-purple] A cor p√∫rpura que alimenta as m√°quinas est√° ficando mais viva, como se fosse sangue lembrando que j√° foi alma. Isso significa que o limite est√° pr√≥ximo.

H√° um lugar onde ainda se pode falar antes que as paredes escutem:  
[highlight]Taverna Ferrugem & Ossos[/highlight]. Distrito Velha Chama.  
Voc√™s v√£o encontr√°-la mesmo que tentem n√£o ir.  
Isso significa que ainda t√™m escolha.  
Ou que j√° n√£o t√™m nenhuma, e s√≥ est√£o descobrindo agora.

Se chegarem a tempo, talvez eu consiga‚Äî  
Talvez ainda haja‚Äî

[burned][trecho ileg√≠vel ‚Äî parte arrancada ou queimada][/burned]

Se ouvirem algu√©m chamar, n√£o respondam de imediato. √Äs vezes, n√£o √© voz. √Äs vezes, √© um reflexo tentando se lembrar de que j√° foi vivo.

Venham antes que a cidade decida que nunca receberam esta carta.  
Antes que eu mesma me conven√ßa de que nunca a escrevi.

[eaten-signature]Arcanista-Mor Lythienne Vael[/eaten-signature]
`.trim();

function esc(s){ return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") }
function parseCarta(raw){
  const paras = raw.split(/\n\s*\n/);
  const html = paras.map(block=>{
    let t = esc(block);
    t = t.replace(/  \n/g, "<br>");
    t = t.replace(/\[burned\]\[trecho ileg√≠vel[^\]]*\]\[\/burned\]/gi, '<span class="fx-missing" aria-label="trecho ileg√≠vel"></span>');
    t = t.replace(/\[fade\]([\s\S]*?)\[\/fade\]/gi, '<span class="fx-fade">$1</span>');
    t = t.replace(/\[glitch\]([\s\S]*?)\[\/glitch\]/gi, '<span class="fx-glitch" data-glitch="1">$1</span>');
    t = t.replace(/\[glow-purple\]([\s\S]*?)\[\/glow-purple\]/gi, '<span class="fx-glow">$1</span>');
    t = t.replace(/\[blur\]([\s\S]*?)\[\/blur\]/gi, '<span class="fx-blur">$1</span>');
    t = t.replace(/\[burned\]([\s\S]*?)\[\/burned\]/gi, '<span class="fx-burned">$1</span>');
    t = t.replace(/\[highlight\]([\s\S]*?)\[\/highlight\]/gi, '<span class="fx-highlight">$1</span>');
    t = t.replace(/\[eaten-signature\]([\s\S]*?)\[\/eaten-signature\]/gi, '<span class="fx-eaten">$1</span>');
    t = t
      .replace(/(?<!\w)(mem√≥ria|memoria)(?!\w)/gi, '<span class="blink">$1</span>')
      .replace(/(?<!\w)(engrenagem)(?!\w)/gi, '<span class="blink">$1</span>')
      .replace(/(?<!\w)(nome)(?!\w)/gi, '<span class="blink">$1</span>')
      .replace(/(?<!\w)(esquecer|esquec[e√™]u|esquecida|esquecido)(?!\w)/gi, '<span class="blink">$1</span>');
    return `<p>${t}</p>`;
  }).join("\n");
  return html;
}
const cartaEl = document.getElementById('carta');
cartaEl.innerHTML = `<h1>‚Äî Carta recuperada do Sensorium ‚Äî</h1>\n` + parseCarta(RAW_TEXT);

const GLYPHS = "·ö†·ö°·ö¢·ö¶·ö®·ö±·ö≤·ö∑·ö∫·õÉ·õá·õà·õâ·õè·õí·õó·õö·õü‚óä‚óá‚óÜ‚ñ≥‚ñΩ‚úß‚ú¶‚ú∑‚ú¥‚ú∂‚úπ";
function glitchOnce(el, dur=90){
  if(el.dataset.glitching === "1") return;
  el.dataset.glitching = "1";
  const orig = el.textContent;
  const arr = orig.split("");
  const n = Math.ceil(arr.length * 0.25);
  const idxs = new Set();
  while(idxs.size < n) idxs.add( Math.floor(Math.random()*arr.length) );
  const mutated = arr.map((ch,i)=> idxs.has(i) && ch.trim()? GLYPHS[Math.floor(Math.random()*GLYPHS.length)] : ch ).join("");
  el.textContent = mutated;
  requestAnimationFrame(()=>{
    setTimeout(()=>{ el.textContent = orig; el.dataset.glitching = "0"; }, dur);
  });
}
setInterval(()=>{
  document.querySelectorAll('.fx-glitch[data-glitch="1"]').forEach(el=>{
    if(Math.random() < 0.18) glitchOnce(el, 80 + Math.random()*120);
  });
}, 260);

document.getElementById('btn-prosseguir').addEventListener('click', ()=>{
  cartaStage.style.opacity = 0;
  setTimeout(()=>{
    cartaStage.style.display='none';
    calcStage.style.display='block';
    requestAnimationFrame(()=> calcStage.style.opacity = 1);
  }, 500);
});

/* =================== CALCULADORA (4‚Äì15, 27 pts) =================== */
const ATTRS=["For√ßa","Destreza","Constitui√ß√£o","Intelig√™ncia","Sabedoria","Carisma"];
const KEY=["str","dex","con","int","wis","cha"];
const COST={4:-4,5:-3,6:-2,7:-1,8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};
const CLASSES={
  "Barbarian":["Path of the Berserker","Path of the Totem Warrior","Path of the Ancestral Guardian","Path of the Storm Herald","Path of the Zealot","Path of the Beast","Path of Wild Magic"],
  "Bard":["College of Lore","College of Valor","College of Glamour","College of Swords","College of Whispers","College of Creation","College of Eloquence"],
  "Cleric":["Knowledge","Life","Light","Nature","Tempest","Trickery","War","Forge","Grave","Order","Peace","Twilight"],
  "Druid":["Circle of the Land","Circle of the Moon","Circle of Dreams","Circle of the Shepherd","Circle of Spores","Circle of Stars","Circle of Wildfire"],
  "Fighter":["Champion","Battle Master","Eldritch Knight","Arcane Archer","Cavalier","Samurai","Psi Warrior","Rune Knight","Echo Knight"],
  "Monk":["Way of the Open Hand","Way of Shadow","Way of the Four Elements","Sun Soul","Kensei","Drunken Master","Mercy","Astral Self"],
  "Paladin":["Oath of Devotion","Oath of the Ancients","Oath of Vengeance","Oath of Conquest","Oath of Redemption","Oath of Glory","Oath of the Watchers"],
  "Ranger":["Hunter","Beast Master","Gloom Stalker","Horizon Walker","Monster Slayer","Fey Wanderer","Swarmkeeper"],
  "Rogue":["Thief","Assassin","Arcane Trickster","Inquisitive","Mastermind","Scout","Swashbuckler","Phantom","Soulknife"],
  "Sorcerer":["Draconic Bloodline","Wild Magic","Divine Soul","Shadow Magic","Storm Sorcery","Aberrant Mind","Clockwork Soul"],
  "Warlock":["The Archfey","The Fiend","The Great Old One","The Celestial","The Hexblade","The Fathomless","The Genie","Undead"],
  "Wizard":["School of Abjuration","Conjuration","Divination","Enchantment","Evocation","Illusion","Necromancy","Transmutation","Bladesinging","Graviturgy","Chronurgy"],
  "Artificer":["Alchemist","Armorer","Artillerist","Battle Smith"]
};
const RUNES = [
  { id:"rust", name:"Runa da Ferrugem (+2 CON)", type:"fixed", bonus:{con:2} },
  { id:"memory", name:"Runa da Lembran√ßa (+2 SAB)", type:"fixed", bonus:{wis:2} },
  { id:"vigil", name:"Runa da Vig√≠lia (+2 DES)", type:"fixed", bonus:{dex:2} },
  { id:"scar", name:"Runa da Cicatriz (+2 FOR)", type:"fixed", bonus:{str:2} },
  { id:"echo", name:"Runa do Eco (+2 CAR)", type:"fixed", bonus:{cha:2} },
  { id:"void", name:"Runa do Vazio (+2 INT)", type:"fixed", bonus:{int:2} },
  { id:"entropy", name:"Runa da Entropia (+1 em dois atributos √† escolha)", type:"two", bonus:{} },
  { id:"coldflame", name:"Runa da Chama Fria (+2 CAR ou INT)", type:"one", options:["cha","int"] },
  { id:"innerbone", name:"Runa do Osso Interior (+2 SAB ou CON)", type:"one", options:["wis","con"] },
  { id:"rupture", name:"Runa da Ruptura (+2 em qualquer atributo)", type:"one-any" },
  { id:"shard", name:"Runa da Fragmenta√ß√£o (indispon√≠vel)", type:"locked", bonus:{} }
];
const state = {
  base: {str:8,dex:8,con:8,int:8,wis:8,cha:8},
  cls: "Fighter",
  subcls: "Champion",
  rune: "rust",
  runeChoice1: null,
  runeChoice2: null
};
const el = {
  cls: document.getElementById("cls"),
  subcls: document.getElementById("subcls"),
  rune: document.getElementById("rune"),
  runeExtras: document.getElementById("runeExtras"),
  rc1Wrap: document.getElementById("runeChoice1Wrap"),
  rc2Wrap: document.getElementById("runeChoice2Wrap"),
  rc1: document.getElementById("runeChoice1"),
  rc2: document.getElementById("runeChoice2"),
  ptsLeft: document.getElementById("ptsLeft"),
  costTotal: document.getElementById("costTotal"),
  validPB: document.getElementById("validPB"),
  stats: document.getElementById("statsGrid"),
  bar: document.getElementById("bar"),
  finalTable: document.getElementById("finalTable"),
  capWarn: document.getElementById("capWarn"),
  summary: document.getElementById("sumText"),
  warnings: document.getElementById("warnings"),
  reset: document.getElementById("reset"),
  export: document.getElementById("export"),
  import: document.getElementById("import")
};
function initClassUI(){
  el.cls.innerHTML = Object.keys(CLASSES).map(c=>`<option value="${c}">${c}</option>`).join("");
  el.cls.value = state.cls;
  fillSubclass();
}
function fillSubclass(){
  const subs = CLASSES[el.cls.value] || [];
  el.subcls.innerHTML = subs.map(s=>`<option value="${s}">${s}</option>`).join("");
  if (!subs.includes(state.subcls)) state.subcls = subs[0] || "";
  el.subcls.value = state.subcls;
}
function initRunes(){
  el.rune.innerHTML = RUNES.map(r => {
    if (r.id==="shard") return `<option value="${r.id}" disabled>üîí ${r.name}</option>`;
    return `<option value="${r.id}">${r.name}</option>`;
  }).join("");
  el.rune.value = state.rune;
  initRuneChoiceUI();
}
function makeAttrOptions(){ return KEY.map((k,i)=>`<option value="${k}">${ATTRS[i]}</option>`).join(""); }
function initRuneChoiceUI(){
  const r = RUNES.find(x=>x.id===el.rune.value);
  el.runeExtras.classList.remove("show");
  el.rc1Wrap.style.display = "none";
  el.rc2Wrap.style.display = "none";
  if (!r) return;
  if (r.type==="one"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc1.innerHTML = r.options.map(k=>{
      const name = ATTRS[KEY.indexOf(k)];
      return `<option value="${k}">${name}</option>`;
    }).join("");
    if (!r.options.includes(state.runeChoice1)) state.runeChoice1 = r.options[0];
    el.rc1.value = state.runeChoice1;
  }
  else if (r.type==="one-any"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc1.innerHTML = makeAttrOptions();
    if (!KEY.includes(state.runeChoice1)) state.runeChoice1 = "str";
    el.rc1.value = state.runeChoice1;
  }
  else if (r.type==="two"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc2Wrap.style.display = "block";
    el.rc1.innerHTML = makeAttrOptions();
    el.rc2.innerHTML = makeAttrOptions();
    if (!KEY.includes(state.runeChoice1) || state.runeChoice1==null) state.runeChoice1 = "str";
    if (!KEY.includes(state.runeChoice2) || state.runeChoice2==null) state.runeChoice2 = "dex";
    el.rc1.value = state.runeChoice1;
    el.rc2.value = state.runeChoice2;
  }
}
function scoreCost(v){ if (v<4 || v>15) return Infinity; return COST[v]; }
function totalCost(base){ return KEY.reduce((sum,k)=>sum + scoreCost(base[k]), 0); }
function pointsLeft(base){ const cost = totalCost(base); return 27 - cost; }
function canInc(base,k){
  const v = base[k]; if (v>=15) return false;
  const hypot = {...base, [k]: v+1}; return totalCost(hypot) <= 27;
}
function canDec(base,k){ const v = base[k]; return v>4; }
function applyRune(base){
  const after = {...base};
  const r = RUNES.find(x=>x.id===el.rune.value);
  let bonus = {str:0,dex:0,con:0,int:0,wis:0,cha:0};
  if (!r) return {after, bonus};
  if (r.type==="fixed"){ bonus = {...bonus, ...r.bonus}; }
  else if (r.type==="one"){ if (el.rc1.value){ bonus[el.rc1.value] += 2; } }
  else if (r.type==="one-any"){ if (el.rc1.value){ bonus[el.rc1.value] += 2; } }
  else if (r.type==="two"){ if (el.rc1.value) bonus[el.rc1.value] += 1; if (el.rc2.value) bonus[el.rc2.value] += 1; }
  KEY.forEach(k => { after[k] = base[k] + bonus[k]; });
  return {after, bonus};
}
function modOf(score){ return Math.floor((score - 10)/2); }

function renderStats(){
  el.stats.innerHTML = KEY.map((k,i)=>{
    const v = state.base[k];
    const cost = scoreCost(v);
    const badgeCls = (cost<0) ? "gain" : "spend";
    const costTxt = (cost>0?"+":"") + cost;
    return `
      <div class="stat" data-k="${k}">
        <h3>${ATTRS[i]}</h3>
        <div class="val">
          <button class="btn-ghost" data-act="dec" ${!canDec(state.base,k)?"disabled":""}>‚Äì</button>
          <div class="n">${v}</div>
          <button class="btn-ghost" data-act="inc" ${!canInc(state.base,k)?"disabled":""}>+</button>
        </div>
        <div class="meta" style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted)">
          <span class="${(v<4 || v>15) ? "warning":""}">Limite: 4‚Äì15</span>
          <span class="cost-badge ${badgeCls}" style="border:1px solid var(--border); padding:2px 8px">Custo: ${Number.isFinite(cost)?costTxt:"‚Äî"}</span>
        </div>
      </div>
    `;
  }).join("");
  el.stats.querySelectorAll(".btn-ghost").forEach(btn=>{
    btn.onclick = () => {
      const card = btn.closest(".stat");
      const k = card.dataset.k;
      const act = btn.dataset.act;
      if (act==="inc" && canInc(state.base,k)) state.base[k]++;
      if (act==="dec" && canDec(state.base,k)) state.base[k]--;
      updateAll();
    };
  });
}
function renderTotals(){
  const cost = totalCost(state.base);
  const left = pointsLeft(state.base);
  el.ptsLeft.textContent = left;
  el.costTotal.textContent = cost;
  el.validPB.textContent = (cost<=27) ? "Sim" : "N√£o";
  el.validPB.className = (cost<=27) ? "ok" : "warning";
  const used = Math.min(27, Math.max(0, cost));
  el.bar.style.width = Math.round((used/27)*100) + "%";
}
function renderResult(){
  const {after, bonus} = applyRune(state.base);
  let capWarn = [];
  let anyWarn = false;
  el.finalTable.innerHTML = KEY.map((k,i)=>{
    const pre = state.base[k];
    const bn = bonus[k]||0;
    const post = after[k];
    if (post>20){ capWarn.push(`${ATTRS[i]} ${post} (>20)`); anyWarn = true; }
    const m = modOf(post);
    return `
      <tr>
        <td style="text-align:left">${ATTRS[i]}</td>
        <td>${pre}</td>
        <td>${bn>=0?`+${bn}`:bn}</td>
        <td>${post}</td>
        <td>${m>=0?`+${m}`:m}</td>
      </tr>
    `;
  }).join("");
  el.capWarn.textContent = capWarn.length ? `Limite 20 excedido em: ${capWarn.join(", ")}` : "‚Äî";
  const cls = el.cls.value, sub = el.subcls.value;
  const runeName = RUNES.find(r=>r.id===el.rune.value)?.name || "‚Äî";
  el.summary.textContent = `Classe: ${cls} ‚Äî Subclasse: ${sub} ‚Äî Runa: ${runeName}`;
  el.warnings.textContent = anyWarn ? "Aten√ß√£o aos limites de 20." : "";
}
function updateAll(){ renderStats(); renderTotals(); renderResult(); }

function exportBuild(){
  const data = {
    base:state.base, cls:el.cls.value, subcls:el.subcls.value, rune:el.rune.value,
    runeChoice1: el.rc1?.value ?? null, runeChoice2: el.rc2?.value ?? null
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "build-pointbuy.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importBuild(file){
  const fr = new FileReader();
  fr.onload = () => {
    try{
      const j = JSON.parse(fr.result);
      if (j.base) state.base = {...state.base, ...j.base};
      if (j.cls) { state.cls = j.cls; el.cls.value = j.cls; fillSubclass(); }
      if (j.subcls) { state.subcls = j.subcls; el.subcls.value = j.subcls; }
      if (j.rune) { state.rune = j.rune; el.rune.value = j.rune; }
      if (j.runeChoice1) state.runeChoice1 = j.runeChoice1;
      if (j.runeChoice2) state.runeChoice2 = j.runeChoice2;
      initRuneChoiceUI(); updateAll();
    }catch(e){ alert("JSON inv√°lido."); }
  };
  fr.readAsText(file);
}
el.cls.onchange = () => { state.cls = el.cls.value; fillSubclass(); updateAll(); };
el.subcls.onchange = () => { state.subcls = el.subcls.value; updateAll(); };
el.rune.onchange = () => { state.rune = el.rune.value; initRuneChoiceUI(); updateAll(); };
document.getElementById("runeChoice1")?.addEventListener("change", ()=>{ state.runeChoice1 = el.rc1.value; updateAll(); });
document.getElementById("runeChoice2")?.addEventListener("change", ()=>{ state.runeChoice2 = el.rc2.value; updateAll(); });
el.reset.onclick = () => { KEY.forEach(k=>state.base[k]=8); updateAll(); };
el.export.onclick = exportBuild;
el.import.onchange = (e)=>{ if (e.target.files[0]) importBuild(e.targe.files[0]); };

(function boot(){
  initClassUI(); initRunes(); renderStats(); renderTotals(); renderResult();
})();
</script>
</body>
</html>

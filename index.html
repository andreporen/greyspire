<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Liturgia da Engrenagem Perp√©tua -- Calculadora, Selo & Lore</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#f3e9cf; --ink-dim:#cabf9d;
    --purple:#b24cff; --purple-deep:#3C0061;
    --muted:#a9a8a5; --danger:#ff4d6d;
    --bg:#000; --panel:rgba(10,8,12,.45);
    --border:rgba(178,76,255,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 10% 0%, rgba(178,76,255,0.06), transparent 60%),
      radial-gradient(1000px 600px at 90% 10%, rgba(60,0,97,0.08), transparent 60%),
      radial-gradient(1600px 1000px at 50% 100%, rgba(178,76,255,0.05), transparent 60%),
      repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 2px),
      #000;
    font-family:'MedievalSharp', cursive;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:1;
    background:
      radial-gradient(1000px 600px at 50% 10%, rgba(0,0,0,0.2), transparent 70%),
      linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.4));
    mix-blend-mode:multiply;
  }

  /* ---------- FLASH ---------- */
  #flash{ position:fixed; inset:0; background:var(--purple); opacity:0; pointer-events:none; z-index:30 }
  .flash-run{ animation:flash .55s ease-out forwards }
  @keyframes flash{ 0%{opacity:0} 10%{opacity:1} 40%{opacity:.9} 100%{opacity:0} }

  /* ---------- SELO SVG (complexo) ---------- */
  #seal-container{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:280px; height:280px; z-index:20;
    display:none; /* aparece no fluxo */
    align-items:center; justify-content:center;
    transition:opacity .45s ease-out;
    opacity:0;
  }
  .seal-svg{ 
    width:100%; height:100%; 
    filter:drop-shadow(0 0 22px rgba(178,76,255,.55)); 
    display:block;
  }
  .seal-pulse{ animation:sealPulse 2.8s ease-in-out infinite }
  .ring-rot{ animation:ringRot 18s linear infinite }
  .sigil-rot{ animation:sigilRot 36s linear infinite }
  .shine{ animation:shine 3.2s ease-in-out infinite; opacity:.9 }
  .strobe{ animation:strobe 4.6s ease-in-out infinite }
  #seal-container:hover .seal-svg{ filter:drop-shadow(0 0 26px rgba(178,76,255,.8)) }
  .seal-hide{ opacity:0 !important; filter:drop-shadow(0 0 6px rgba(178,76,255,.2)) }

  .fma-circle-outer { stroke:#b24cff; stroke-width:3; fill:none; filter:url(#fma-glow) }
  .fma-circle-inner { stroke:#b24cff; stroke-width:1.5; fill:none; opacity:0.7 }
  .fma-rune { fill:#b24cff; font-family:'Cinzel Decorative', serif; font-size:32px; text-anchor:middle; dominant-baseline:central; }
  .fma-symbol { stroke:#fff; stroke-width:2; fill:none; filter:url(#fma-glow-white); }
  .fma-star { fill:#fff; filter:url(#fma-glow-white); }
  .fma-inner-ring-rot { animation:ringRot 12s linear infinite reverse }
  .fma-outer-ring-rot { animation:ringRot 28s linear infinite }

  @keyframes sealPulse{ 0%,100%{ transform:scale(.965) } 50%{ transform:scale(1) } }
  @keyframes ringRot{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  @keyframes sigilRot{ from{transform:rotate(0deg)} to{transform:rotate(-360deg)} }
  @keyframes shine{
    0%,100%{ filter:brightness(1) drop-shadow(0 0 8px #b24cff) }
    50%{ filter:brightness(1.15) drop-shadow(0 0 18px #b24cff) }
  }
  @keyframes strobe{
    0%,92%{ opacity:1 } 94%{ opacity:.5 } 96%{ opacity:.9 } 98%{opacity:.4} 100%{opacity:1}
  }

  /* ---------- EST√ÅGIOS ---------- */
  #carta-stage, #lore-stage, #world-stage { 
    display:none; opacity:0; transition:opacity .8s ease; position:relative; z-index:2; 
  }
  #carta-wrap, .lore-wrap, .world-wrap {
    max-width:900px; margin:8vh auto 4vh; padding:28px 22px;
    background: var(--panel);
    border:1px solid var(--border);
    box-shadow: 0 0 24px rgba(178,76,255,.18), inset 0 0 60px rgba(178,76,255,.05);
    position:relative; overflow:hidden;
  }
  .lore-wrap h1, .world-wrap h1, #carta h1 {
    font-family:'Cinzel Decorative', cursive; color:var(--purple); margin:0 0 14px 0;
    font-size:clamp(20px,3.6vw,28px); letter-spacing:.5px; text-shadow:0 0 12px rgba(178,76,255,.6);
  }
  .world-wrap p { color: var(--ink); }

  .chapter-menu { display:flex; flex-direction:column; gap:12px; margin-top:20px }
  .chapter-btn { font-size:18px; padding:14px 20px; text-align:left; color:var(--ink); border:1px solid var(--border) }
  .chapter-btn:hover { color:#fff; background: rgba(178, 76, 255, 0.1) }
  .chapter-btn strong { font-family:'Cinzel Decorative', cursive; color:var(--purple); margin-right:12px }

  #carta p{ line-height:1.65; color:var(--ink); margin:10px 0; text-indent:0 }
  .actions{ margin-top:20px; display:flex; flex-wrap:wrap; gap:10px }
  .btn{
    appearance:none; border:1px solid var(--purple); background:#000; color:#fff;
    padding:10px 14px; cursor:pointer; font-family:'Cinzel Decorative', cursive;
    box-shadow:0 0 18px rgba(178,76,255,.18); letter-spacing:.3px;
    transition:box-shadow .3s, border-color .3s, transform .2s;
  }
  .btn:hover{ border-color:#fff; box-shadow:0 0 22px rgba(178,76,255,.32); transform:translateY(-1px) }
  .btn.btn-primary { background: var(--purple); color:#000; font-weight:700 }
  .btn.btn-primary:hover{ background:#fff; border-color:#fff }

  /* Carta FX */
  .fx-fade{ animation:fadePulse 6.5s ease-in-out infinite }
  @keyframes fadePulse{ 0%,100%{opacity:1} 40%{opacity:.45} 60%{opacity:.9} }

  /* NOVO BLINK (sem flicker; mem√≥ria oscilante) */
  .fx-blink{
    position:relative; display:inline-block;
    animation:blinkSoft 3.8s ease-in-out infinite;
  }
  .fx-blink::after{
    content: attr(data-shadow);
    position:absolute; left:0; top:0;
    color:#fff; opacity:.0;
    text-shadow: 0 0 10px var(--purple), 0 0 22px var(--purple);
    filter: blur(1px);
    transform: translate(0,0);
    animation: blinkGhost 3.8s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes blinkSoft{
    0%,100%{ opacity:1; transform:translate(0,0) }
    40%    { opacity:.68; transform:translate(0.2px,0) }
    55%    { opacity:.92; transform:translate(-0.15px,0) }
  }
  @keyframes blinkGhost{
    0%,100%{ opacity:0; transform: translate(0,0) }
    40%    { opacity:.22; transform: translate(0.4px,0) }
    55%    { opacity:.12; transform: translate(-0.3px,0) }
  }

  .fx-glow{ color:#fff; text-shadow:0 0 6px #fff,0 0 14px var(--purple),0 0 26px var(--purple),0 0 42px var(--purple-deep);
            animation:glowBreath 3.4s ease-in-out infinite }
  @keyframes glowBreath{ 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.15)} }

  .fx-blur{ filter:blur(1.4px); transition:filter .35s ease }
  .fx-blur:hover{ filter:blur(0) }

  .fx-highlight{ color:#fff; text-shadow:0 0 10px var(--purple),0 0 22px var(--purple),0 0 44px var(--purple); position:relative }
  .fx-highlight::after{ content:""; position:absolute; left:-2px; right:-2px; bottom:-1px; height:1px;
    box-shadow:0 0 10px var(--purple),0 0 20px var(--purple) }

  .fx-burned{ position:relative; display:inline-block; padding:0 .1em; color:var(--ink);
    --mask: radial-gradient(8px 5px at 0% 70%, transparent 40%, black 60%) repeat-x,
            radial-gradient(6px 4px at 100% 30%, transparent 45%, black 65%) repeat-x;
    -webkit-mask: var(--mask); mask: var(--mask);
    -webkit-mask-size:18px 100%,14px 100%; mask-size:18px 100%,14px 100%;
    filter: drop-shadow(0 0 2px rgba(0,0,0,.6)) }

  .fx-missing{ display:inline-block; width:11ch; height:1em; color:transparent; position:relative; vertical-align:baseline }
  .fx-missing::before{
    content:""; position:absolute; inset:-2px -3px;
    background:
      radial-gradient(12px 7px at 12% 60%, rgba(0,0,0,0.9), transparent 70%) repeat-x,
      radial-gradient(10px 6px at 88% 40%, rgba(0,0,0,0.9), transparent 65%) repeat-x;
    filter: blur(.6px);
    -webkit-mask: radial-gradient(9px 6px at 12% 60%, black 55%, transparent 56%) repeat-x,
                  radial-gradient(8px 5px at 88% 40%, black 55%, transparent 56%) repeat-x;
    -webkit-mask-size:18px 100%,16px 100%;
    mask: radial-gradient(9px 6px at 12% 60%, black 55%, transparent 56%) repeat-x,
          radial-gradient(8px 5px at 88% 40%, black 55%, transparent 56%) repeat-x;
    mask-size:18px 100%,16px 100%;
  }

  .fx-glitch{ position:relative }
  .fx-glitch[data-glitching="1"]{ text-shadow:0 0 6px rgba(178,76,255,.9), 0 0 18px rgba(178,76,255,.6); filter:hue-rotate(10deg) saturate(1.2) }

  .fx-eaten{
    display:inline-block; position:relative; color:#fff;
    text-shadow:0 0 6px #fff,0 0 16px var(--purple),0 0 28px var(--purple);
    -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);
            mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);
    animation:eat 6.5s steps(80,end) forwards, glowBreath 3.4s ease-in-out infinite;
  }
  @keyframes eat{
    0%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 0);}
    70%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 70%); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 70%);}
    100%{ -webkit-mask: conic-gradient(from 0deg at 50% 50%, transparent 0 100%); mask: conic-gradient(from 0deg at 50% 50%, transparent 0 100%);}
  }

  /* ---------- CALCULADORA ---------- */
  #calc-stage{ opacity:1; transition:opacity .8s ease; position:relative; z-index:2 }
  header.calc-head{ padding:18px 16px 8px; text-align:center }
  header.calc-head h1{
    margin:0; font-size:clamp(22px,3.6vw,30px); color:var(--purple);
    font-family:'Cinzel Decorative', cursive; text-shadow:0 0 12px rgba(178,76,255,.6);
  }
  header.calc-head p{ margin:6px 0 0; color:var(--muted) }
  main.calc{ max-width:1152px; margin:16px auto 40px; padding:0 14px; display:grid; gap:16px; grid-template-columns:1fr }
  @media(min-width:980px){ main.calc{ grid-template-columns:2.1fr 1.4fr } }
  .card{
    background:var(--panel); border:1px solid var(--border);
    box-shadow: 0 0 24px rgba(178,76,255,.15), inset 0 0 60px rgba(178,76,255,.05);
  }
  .card h2{
    margin:0; padding:14px 16px; font-size:18px; color:var(--purple);
    border-bottom:1px solid var(--border); font-family:'Cinzel Decorative', cursive;
  }
  .body{ padding:14px }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .control{ display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1 }
  label{ font-size:12px; color:var(--muted) }

  select{
    -webkit-appearance:none; appearance:none;
    width:100%;
    border:1px solid var(--border);
    background: #000;
    color:#fff;
    border-radius:0;
    padding:10px 36px 10px 12px;
    font-size:14px;
    font-family:'MedievalSharp', cursive;
    outline:none;
    transition:border-color .25s, box-shadow .25s;
    background-image:
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='20' viewBox='0 0 28 20'><polyline points='6,7 14,15 22,7' fill='none' stroke='%23b24cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
    background-repeat:no-repeat; background-position:right 8px center; background-size:22px 16px;
  }
  select:focus{ border-color:#fff; box-shadow:0 0 6px #fff,0 0 12px var(--purple),0 0 18px var(--purple) }

  input[type="number"], .btn{
    border:1px solid var(--border); background:#000; color:#fff; border-radius:0; padding:10px 12px; font-size:14px
  }
  .grid-6{ display:grid; grid-template-columns:repeat(6,1fr); gap:10px }
  @media(max-width:820px){ .grid-6{ grid-template-columns:repeat(3,1fr) } }
  @media(max-width:520px){ .grid-6{ grid-template-columns:repeat(2,1fr) } }
  .stat{ border:1px solid var(--border); padding:10px }
  .stat h3{ margin:0; font-size:12px; color:var(--muted); text-align:center; letter-spacing:.5px; font-family:'Cinzel Decorative', cursive; }
  .val{ display:flex; align-items:center; justify-content:center; gap:8px }
  .n{ font-size:24px; font-weight:700; min-width:40px; text-align:center }
  .btn-ghost{ border:1px solid #7b7690; background:transparent; color:#7b7690; width:36px; height:32px; font-weight:700; font-family:sans-serif; cursor:pointer }
  .btn-ghost:hover:not(:disabled){ color:#fff; border-color:#fff }

  .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); background:transparent; border-radius:0; font-size:12px }
  .bar{height:8px; background:transparent; border:1px solid var(--border); border-radius:0; overflow:hidden}
  .bar > i{display:block; height:100%; width:0%; background:var(--purple)}
  .ok{ color:#00d38c; font-weight:600 } .warning{ color:var(--danger); font-weight:600 }
  table{ width:100%; border-collapse:collapse; font-size:13px; background:transparent }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:center }
  th{ color:var(--purple); font-family:'Cinzel Decorative', cursive }
  .rune-extra{ display:none; gap:10px; margin-top:10px }
  .rune-extra.show{ display:flex }
</style>
</head>
<body>

<div id="flash"></div>

<!-- SELO -->
<div id="seal-container" aria-label="Ativar Selo Arcano">
  <svg class="seal-svg seal-pulse strobe" aria-hidden="true"
       viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="gPurple" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.95"/>
        <stop offset="45%" stop-color="#b24cff" stop-opacity="0.85"/>
        <stop offset="100%" stop-color="#3C0061" stop-opacity="0.0"/>
      </radialGradient>
      <filter id="fma-glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="3" result="glow"/>
        <feMerge>
          <feMergeNode in="glow"/>
          <feMergeNode in="SourceGraphic"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <filter id="fma-glow-white" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="1.5" result="glow"/>
        <feFlood flood-color="#ffffff" flood-opacity="0.8" result="color"/>
        <feComposite in="color" in2="glow" operator="in" result="glow-colored"/>
        <feMerge>
          <feMergeNode in="glow-colored"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>

    <!-- Halo Externo -->
    <circle cx="256" cy="256" r="230" fill="url(#gPurple)" opacity="0.15"/>

    <!-- Anel de Runas Externo -->
    <g transform="translate(256 256)">
      <g class="fma-outer-ring-rot">
        <circle cx="0" cy="0" r="240" class="fma-circle-outer"/>
        <circle cx="0" cy="0" r="248" fill="none" stroke="#b24cff" stroke-opacity=".35" stroke-width="1"/>
        <g class="fma-rune" fill="#b24cff" font-size="28">
          <text x="0" y="-220" transform="rotate(0)">·ö†</text>
          <text x="110" y="-190" transform="rotate(30)">·ö¶</text>
          <text x="200" y="-90" transform="rotate(60)">·ö®</text>
          <text x="220" y="0" transform="rotate(90)">·ö±</text>
          <text x="200" y="90" transform="rotate(120)">·ö≤</text>
          <text x="110" y="190" transform="rotate(150)">·ö∑</text>
          <text x="0" y="220" transform="rotate(180)">·ö∫</text>
          <text x="-110" y="190" transform="rotate(210)">·õÉ</text>
          <text x="-200" y="90" transform="rotate(240)">·õá</text>
          <text x="-220" y="0" transform="rotate(270)">·õà</text>
          <text x="-200" y="-90" transform="rotate(300)">·õâ</text>
          <text x="-110" y="-190" transform="rotate(330)">·õè</text>
        </g>
      </g>
    </g>

    <!-- Anel Interno -->
    <g transform="translate(256 256)">
      <g class="fma-inner-ring-rot">
        <circle cx="0" cy="0" r="170" class="fma-circle-inner"/>
        <g class="fma-symbol">
          <path d="M-150,0 Q-100,-70 0,-150 Q100,-70 150,0 Q100,70 0,150 Q-100,70 -150,0 Z" stroke-width="1.8"/>
          <line x1="-150" y1="0" x2="150" y2="0"/>
          <line x1="0" y1="-150" x2="0" y2="150"/>
        </g>
        <circle cx="0" cy="-170" r="4" class="fma-star"/>
        <circle cx="0" cy="170" r="4" class="fma-star"/>
        <circle cx="170" cy="0" r="4" class="fma-star"/>
        <circle cx="-170" cy="0" r="4" class="fma-star"/>
      </g>
    </g>

    <!-- Sigilo Central -->
    <g class="shine" transform="translate(256 256)">
      <circle cx="0" cy="0" r="100" class="fma-circle-outer"/>
      <g class="sigil-rot" stroke="#b24cff" stroke-width="2.5" opacity=".9" filter="url(#fma-glow)">
        <polygon points="0,-80 70,40 -70,40" fill="none"/>
        <line x1="0" y1="-80" x2="0" y2="60"/>
        <line x1="-70" y1="40" x2="70" y2="40"/>
        <circle cx="0" cy="0" r="22" fill="none" stroke="#fff" stroke-width="1.5"/>
        <circle cx="0" cy="0" r="5" fill="#fff" filter="url(#fma-glow-white)"/>
      </g>
    </g>

    <!-- Runas Internas -->
    <g transform="translate(256 256)">
      <circle cx="0" cy="0" r="70" fill="none" stroke="#ffffff" stroke-opacity=".6" stroke-width="0.8"/>
      <g class="fma-rune" font-size="18">
        <text x="-45" y="-30">·õñ</text>
        <text x="45" y="-30">·õú</text>
        <text x="0" y="50">·õû</text>
      </g>
    </g>
  </svg>
</div>

<!-- CALCULADORA (Tela Inicial) -->
<section id="calc-stage">
  <header class="calc-head">
    <h1>Calculadora Point Buy -- D&D 5e (27 pontos) + Runas</h1>
    <p>Distribua 27 pontos (pr√©-runa <strong>4‚Äì15</strong>). Abaixo de 8 devolve pontos. Acima de 15 √© inv√°lido antes da runa.</p>
  </header>

  <main class="calc">
    <section class="card">
      <h2>Configura√ß√£o</h2>
      <div class="body" style="display:grid; gap:12px; grid-template-columns:1fr;">
        <div class="row">
          <div class="control">
            <label>Classe</label>
            <select id="cls"></select>
          </div>
          <div class="control">
            <label>Subclasse</label>
            <select id="subcls"></select>
          </div>
        </div>

        <div class="row">
          <div class="control">
            <label>Runa</label>
            <select id="rune"></select>
          </div>
          <div id="runeExtras" class="rune-extra">
            <div class="control" id="runeChoice1Wrap">
              <label>Escolha de atributo (runa)</label>
              <select id="runeChoice1"></select>
            </div>
            <div class="control" id="runeChoice2Wrap">
              <label>2¬™ escolha (Runa da Entropia)</label>
              <select id="runeChoice2"></select>
            </div>
          </div>
        </div>

        <div class="row">
          <span class="pill">Pontos restantes: <strong id="ptsLeft">27</strong> / 27</span>
          <span class="pill">Custo total (gastos ‚Äì ganhos): <strong id="costTotal">0</strong></span>
          <span class="pill">Pr√©-runa v√°lido: <strong id="validPB" class="ok">Sim</strong></span>
        </div>
        <div class="control">
          <label>Progresso de compra (0 a 27)</label>
          <div class="bar"><i id="bar"></i></div>
        </div>
        <div class="actions">
          <button class="btn" id="reset">Zerar (8 em tudo)</button>
          <button class="btn" id="export">Exportar Build (JSON)</button>
          <label class="btn" style="cursor:pointer">Importar
            <input type="file" id="import" accept="application/json" style="display:none">
          </label>
          <button class="btn btn-primary" id="btn-go-to-lore">Ir para Lore</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Atributos (pr√©-runa)</h2>
      <div class="body">
        <div class="grid-6" id="statsGrid"></div>
        <div class="hint" style="margin-top:6px; color:var(--muted)">Permitido: 4‚Äì15 antes de aplicar a Runa. Custo negativo significa que voc√™ ganhou pontos.</div>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <h2>Resultado Final (ap√≥s Runa)</h2>
      <div class="body">
        <div class="row" style="align-items:flex-end;">
          <div class="control" style="width:100%">
            <label>Resumo</label>
            <div id="summary" class="pill" style="width:100%; justify-content:space-between">
              <span id="sumText" class="muted">--</span>
              <span id="warnings" style="color:var(--danger)"></span>
            </div>
          </div>
        </div>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Atributo</th><th>Pr√©-Runa</th><th>B√¥nus da Runa</th><th>P√≥s-Runa</th><th>Mod</th>
              </tr>
            </thead>
            <tbody id="finalTable"></tbody>
            <tfoot>
              <tr>
                <td colspan="5" style="text-align:left">
                  <span class="muted">Avisos:</span> <span id="capWarn" style="color:var(--danger)"></span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </main>
</section>

<!-- MENU DE LORE (Cap√≠tulos) -->
<section id="lore-stage">
  <div class="lore-wrap">
    <h1>Arquivos da Liturgia da Engrenagem Perp√©tua</h1>
    <div class="chapter-menu">
      <button class="btn chapter-btn" id="btn-chapter-1">
        <strong>Cap√≠tulo 1:</strong> A Carta Encontrada
      </button>
      <button class="btn chapter-btn" id="btn-chapter-2">
        <strong>Cap√≠tulo 2:</strong> Arquivo P√∫blico de Greyspire - Vers√£o Autorizada
      </button>
    </div>
  </div>
</section>

<!-- CARTA (Cap√≠tulo 1) -->
<section id="carta-stage">
  <div id="carta-wrap">
    <div id="carta"></div>
    <div class="actions">
      <button class="btn" id="btn-back-to-lore">Voltar ao Menu</button>
    </div>
  </div>
</section>

<!-- RESUMO DO MUNDO (Cap√≠tulo 2) -->
<section id="world-stage">
  <div class="world-wrap">
    <h1>  Greyspire √© a maior cidade ainda funcional do Velho Imp√©rio e, para muitos, o √∫ltimo exemplo de civiliza√ß√£o ordenada ap√≥s a Guerra Arcana. Sua exist√™ncia n√£o √© atribu√≠da √† for√ßa militar nem √† estabilidade pol√≠tica, mas ao fato de ter aprendido a administrar o colapso em vez de resistir a ele. A cidade permanece de p√© n√£o porque venceu a devasta√ß√£o, mas porque a organizou.
  As bases sociais de Greyspire n√£o est√£o fundadas em riqueza, tradi√ß√£o de sangue ou linhagens nobres. Toda a estrutura da cidade √© determinada pela magia, e esta √© medida pela runa que cada cidad√£o recebe ao nascer. As runas n√£o s√£o escolhidas, aplicadas ou herdadas: elas surgem como parte do corpo, e a partir desse instante a pessoa est√° situada no sistema para o restante da vida. Quanto maior o dom√≠nio arcano, maior a posi√ß√£o social. Os portadores de runas elevadas ocupam as camadas superiores, atuando como magos, tecnomantes, decifradores, estrategistas e membros da Liturgia. Os de afinidade moderada assumem fun√ß√µes t√©cnicas ou militares. Os de potencial m√≠nimo s√£o m√£o de obra descart√°vel, √∫teis at√© o ponto em que continuem obedientes. H√° ainda os sem-runa, que n√£o pertencem oficialmente a nenhuma categoria. S√£o ignorados pela administra√ß√£o, sem documentos, sem direitos, sem relev√¢ncia. Exist√™ncia tolerada, nunca reconhecida.
  Esse modelo n√£o √© considerado injusto em Greyspire. √â considerado natural.
  A guerra que definiu o estado atual do mundo n√£o terminou com ru√≠nas, ex√©rcitos vencidos ou tratados pol√≠ticos. O Velho Imp√©rio executou o Ritual da Converg√™ncia, uma tentativa de eliminar a Federa√ß√£o Arcana de forma absoluta, n√£o militar. O efeito foi imediato. A Federa√ß√£o n√£o foi derrotada. Foi retirada da realidade. Em vez de territ√≥rio conquistado, restou aus√™ncia. No lugar onde ficavam cidades, fronteiras e pessoas, estabeleceu-se a Fenda: um espa√ßo onde a l√≥gica n√£o se completa e o tempo n√£o reconhece sequ√™ncia. A Liturgia afirma que ela √© perigosa, irrevers√≠vel e distante o bastante para que a cidade continue est√°vel. Nenhum texto oficial explica como uma aus√™ncia pode continuar ativa.
  Greyspire, no entanto, n√£o se sustenta apenas pela dist√¢ncia da Fenda. Ela depende da Engrenagem Perp√©tua, instalada em profundidade desconhecida sob o solo. O mecanismo √© reconhecido publicamente, mas n√£o descrito. Nenhum documento civil informa quem a construiu, quando foi iniciada ou de que forma opera. A explica√ß√£o utilizada pela Liturgia √© sempre id√™ntica: a Engrenagem mant√©m a sanidade coletiva da cidade. Ela impede que os efeitos da Fenda ultrapassem os limites do controle. O que acontece se ela parar, ningu√©m diz. A cidade inteira escuta seu ru√≠do subterr√¢neo, mas finge que n√£o o ouve.
  A Liturgia √© a autoridade m√°xima de Greyspire. N√£o governa oficialmente, mas toda decis√£o real depende de sua aprova√ß√£o. Ela controla o uso de magia, o registro das runas, o protocolo sobre a Fenda e o acesso a qualquer informa√ß√£o considerada perigosa para a ordem. N√£o h√° forma p√∫blica de contestar sua doutrina, pois a doutrina n√£o √© debate. √â estrutura. A Liturgia define o que √© est√°vel, o que √© an√¥malo, o que √© aceit√°vel e quem deve desaparecer antes que se torne um problema.
  Magos s√£o a classe mais alta da cidade. S√£o admirados, preservados, estudados e vigiados. N√£o s√£o apenas indiv√≠duos com poder, mas pe√ßas do equil√≠brio urbano. Sua exist√™ncia vale mais do que ex√©rcitos, pois sem eles n√£o h√° rituais, nem tecnologia arcana, nem Engrenagem, nem defesa contra a Fenda. Ao mesmo tempo, o mago √© tamb√©m aquele que mais se aproxima do limite do aceit√°vel. Uma mente poderosa demais pode ser √∫til. Ou pode ser removida antes que deixe de obedecer.
  Nada em Greyspire se move sem magia. Nada em Greyspire respira sem controle. A cidade n√£o teme monstros, teme falhas no sistema. A estabilidade √© considerada a maior virtude. O pre√ßo dela √© a aus√™ncia de perguntas.
  Greyspire continua a existir. O que acontece fora dela n√£o √© tema de interesse urbano. A Fenda permanece distante, mas permanente. A Engrenagem continua girando, mas ningu√©m sabe por quanto tempo. As runas continuam surgindo, mas algumas j√° come√ßaram a mudar. A cidade permanece funcional. A Liturgia afirma que isso √© suficiente.
  At√© agora, √©.</h1>
    <div id="world-text"></div>
    <div class="actions">
      <button class="btn" id="btn-world-back-to-lore">Voltar ao Menu</button>
    </div>
  </div>
</section>

<script>
/* =================== √ÅUDIO: Coral Arcano Et√©reo (WebAudio) =================== */
let audioCtx, masterGain, choir = null, audioPlaying = false;

function ensureAudioCtx(){
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}

function createReverb(ctx, seconds=2.4, decay=2.8){
  const rate = ctx.sampleRate;
  const len = Math.max(1, Math.floor(rate * seconds));
  const ir = ctx.createBuffer(2, len, rate);
  for (let ch=0; ch<2; ch++){
    const data = ir.getChannelData(ch);
    for (let i=0; i<len; i++){
      const n = (Math.random()*2-1);
      data[i] = n * Math.pow(1 - i/len, decay);
    }
  }
  const convolver = ctx.createConvolver();
  convolver.buffer = ir;
  return convolver;
}

function startArcaneChoir(){
  if (audioPlaying) return;
  const ctx = ensureAudioCtx();

  masterGain = ctx.createGain();
  masterGain.gain.value = 0.0001;
  masterGain.connect(ctx.destination);

  const reverb = createReverb(ctx, 2.8, 3.2);
  const wetGain = ctx.createGain(); wetGain.gain.value = 0.45;
  const dryGain = ctx.createGain(); dryGain.gain.value = 0.65;

  const voices = [];
  const base = 196.0; // G3 ~ coral grave
  const ratios = [1, 1.25, 1.5, 2]; // G3, a 4¬™, a 5¬™, oitava
  const detunes = [-8, -3, +3, +7]; // cents aproximados

  // LFOs para vibrato e "respira√ß√£o"
  const lfoVibr = ctx.createOscillator(); lfoVibr.type='sine'; lfoVibr.frequency.value = 0.45;
  const lfoVibrGain = ctx.createGain(); lfoVibrGain.gain.value = 4; // cents
  lfoVibr.connect(lfoVibrGain);

  const lfoBreath = ctx.createOscillator(); lfoBreath.type='sine'; lfoBreath.frequency.value = 0.07;
  const lfoBreathGain = ctx.createGain(); lfoBreathGain.gain.value = 0.14;
  lfoBreath.connect(lfoBreathGain);

  // "Formantes" leves com filtros bandpass para timbre vocal
  const formantFreqs = [600, 1150, 2900]; // muito simplificado
  const voiceOut = ctx.createGain(); voiceOut.gain.value = 0.9;

  ratios.forEach((r, i) => {
    const osc = ctx.createOscillator();
    osc.type = (i%2===0) ? 'triangle' : 'sine';
    osc.frequency.value = base * r;
    osc.detune.value = detunes[i] || 0;

    // modulando detune (vibrato em cents)
    lfoVibrGain.connect(osc.detune);

    // ganho individual com "respira√ß√£o"
    const g = ctx.createGain();
    g.gain.value = 0.22;
    lfoBreathGain.connect(g.gain);

    // cadeia de formantes (bem leve)
    let last = osc;
    formantFreqs.forEach((ff, idx) => {
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.value = ff * (1 + (i-1)*0.02); // leve varia√ß√£o
      bp.Q.value = 1.2 + idx*0.3;
      last.connect(bp);
      last = bp;
    });

    last.connect(g).connect(voiceOut);
    osc.start();
    voices.push(osc);
  });

  // Som "ar" mec√¢nico sutil
  const len = ctx.sampleRate*2;
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const d = buf.getChannelData(0); let prev=0;
  for(let i=0;i<d.length;i++){ const w=Math.random()*2-1; prev = prev*0.97 + w*0.03; d[i]=prev*0.5; }
  const noise = ctx.createBufferSource(); noise.buffer=buf; noise.loop=true;
  const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=340; bp.Q.value=2.2;
  const gNoise = ctx.createGain(); gNoise.gain.value = 0.06;
  noise.connect(bp).connect(gNoise).connect(voiceOut);
  noise.start();

  // Wet/dry
  const preRev = ctx.createGain(); preRev.gain.value = 0.9;
  voiceOut.connect(preRev);
  preRev.connect(reverb);
  reverb.connect(wetGain).connect(masterGain);
  voiceOut.connect(dryGain).connect(masterGain);

  // Fade-in
  masterGain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.8);
  masterGain.gain.linearRampToValueAtTime(0.32, ctx.currentTime + 3.2);

  lfoVibr.start(); lfoBreath.start();

  choir = { voices, noise, lfoVibr, lfoBreath, nodes:[voiceOut, preRev, reverb, wetGain, dryGain] };
  audioPlaying = true;
}

function stopArcaneChoir(){
  if (!audioCtx || !audioPlaying || !choir) return;
  const t = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(t);
  masterGain.gain.linearRampToValueAtTime(0.0001, t + 1.2);
  setTimeout(()=>{
    try{
      choir.voices.forEach(v=>v.stop());
      choir.noise.stop();
      choir.lfoVibr.stop();
      choir.lfoBreath.stop();
    }catch(e){}
    choir = null;
    audioPlaying = false;
  }, 1400);
}

/* =================== TRANSI√á√ïES & SELO =================== */
const seal = document.getElementById('seal-container');
const flashEl = document.getElementById('flash');
const calcStage  = document.getElementById('calc-stage');
const loreStage = document.getElementById('lore-stage');
const cartaStage = document.getElementById('carta-stage');
const worldStage = document.getElementById('world-stage');

const btnGoToLore = document.getElementById('btn-go-to-lore');
const btnChapter1 = document.getElementById('btn-chapter-1');
const btnChapter2 = document.getElementById('btn-chapter-2');
const btnBackToLore = document.getElementById('btn-back-to-lore');
const btnWorldBackToLore = document.getElementById('btn-world-back-to-lore');

function transitionTo(stageToShow, stageToHide) {
  if (stageToHide) {
    stageToHide.style.opacity = 0;
    setTimeout(() => { stageToHide.style.display = 'none'; }, 500);
  }
  if (stageToShow) {
    stageToShow.style.display = 'block';
    requestAnimationFrame(() => { stageToShow.style.opacity = 1; });
  }
}

btnGoToLore.addEventListener('click', ()=>{
  // Flash e esconder calculadora
  flashEl.classList.remove('flash-run'); void flashEl.offsetWidth; flashEl.classList.add('flash-run');
  transitionTo(null, calcStage);

  // Mostrar Selo + iniciar √°udio (iOS-safe: ap√≥s esta intera√ß√£o)
  setTimeout(() => {
    seal.style.display = 'flex';
    requestAnimationFrame(() => {
      seal.style.opacity = 1;
      startArcaneChoir(); // <-- √°udio come√ßa aqui
    });
  }, 500);

  // Esconder selo e mostrar menu
  setTimeout(()=>{
    flashEl.classList.remove('flash-run'); void flashEl.offsetWidth; flashEl.classList.add('flash-run');
    seal.classList.add('seal-hide');
    transitionTo(loreStage, null);
    setTimeout(()=>{ seal.style.display = 'none'; }, 420);
  }, 3000);
});

btnChapter1.addEventListener('click', () => transitionTo(cartaStage, loreStage));
btnChapter2.addEventListener('click', () => transitionTo(worldStage, loreStage));
btnBackToLore.addEventListener('click', () => transitionTo(loreStage, cartaStage));
btnWorldBackToLore.addEventListener('click', () => transitionTo(loreStage, worldStage));

/* =================== CARTA: parser de tags + glitches =================== */
const RAW_TEXT = `
[fade]N√£o sei quanto tempo me resta antes de n√£o restar tempo algum.[/fade] J√° sinto o meu nome se afastando de mim como um [blink]dente morto[/blink] empurrado pela l√≠ngua. Se lerem isto, n√£o procurem quem escreveu. O que sobra de mim j√° n√£o √© pessoa, mas [glitch]ru√≠do[/glitch].

[glitch]A Engrenagem est√° acelerando.[/glitch] Isso n√£o √© met√°fora. H√° algo que ela n√£o consegue mais conter, e a Liturgia sabe, mesmo que finja medir tudo com gr√°ficos e rezas. N√£o √© verdade que ela apenas drena o que enlouqueceria os cidad√£os. [fade]Ela come√ßou a drenar o que os faz lembrar que ainda s√£o humanos.[/fade]

Eu fui parte disso. Eu recitei as f√≥rmulas. Eu acreditei que manter a cidade s√£ era um bem maior. S√≥ agora percebo que existem formas de loucura mais honestas do que a [blink]ordem[/blink] que impomos. A cada rota√ß√£o:

[glow-purple]uma emo√ß√£o √© apagada[/glow-purple]  
[glow-purple]uma mem√≥ria √© dilu√≠da[/glow-purple]  
[glow-purple]um rosto √© removido do mundo[/glow-purple]

[blur]Eu j√° n√£o lembro quem eram meus pais.[/blur]  
Ontem, acho que ainda lembrava.  
Agora s√≥ sei que um dia reconheci a palavra "m√£e" como algo meu, e ela me soa [glitch]estrangeira[/glitch].

N√£o esperem que Œ∑ cidade grite quando come√ßar a [blink]morrer[/blink]. Ela vai sorrir. Ela vai agradecer. √â o que acontece quando se [blink]esquece[/blink] o que se perdeu.

Algu√©m precisa descer at√© onde a [blink]Engrenagem[/blink] respira. Algu√©m que ainda possa ser lembrado. Eu n√£o posso mais. [glitch]Estou sendo reescrita enquanto escrevo.[/glitch]

Se sentirem a cabe√ßa pesar, n√£o √© culpa de voc√™s. √â ela. A m√°quina tentando transformar suas mentes em [burned]arquivo apag√°vel[/burned]. Resistam. Repitam o pr√≥prio nome. Lembrem-se das m√£os. Lembrem-se do que [highlight]escolheram ser[/highlight] antes de a cidade escolher por voc√™s.

[glow-purple]O sensorium est√° oscilando.[/glow-purple] A cor p√∫rpura que alimenta as m√°quinas est√° ficando mais viva, como se fosse sangue lembrando que j√° foi alma. Isso significa que o [blink]limite est√° pr√≥ximo[/blink].

H√° um lugar onde ainda se pode falar antes que as paredes escutem:  
[highlight]Taverna Ferrugem & Ossos[/highlight]. Distrito Velha Chama.  
Voc√™s v√£o encontr√°-la mesmo que tentem n√£o ir.  
Isso significa que ainda t√™m escolha.  
Ou que j√° n√£o t√™m nenhuma, e s√≥ est√£o [blur]descobrindo agora[/blur].

Se chegarem a tempo, talvez eu consiga--  
Talvez ainda haja--

[burned][trecho ileg√≠vel -- parte arrancada ou queimada][/burned]

Se ouvirem algu√©m chamar, n√£o respondam de imediato. √Äs vezes, n√£o √© voz. √Äs vezes, √© um [glitch]reflexo[/glitch] tentando se lembrar de que j√° foi vivo.

Venham antes que a cidade decida que nunca receberam esta carta.  
Antes que eu mesma me conven√ßa de que nunca a [fade]escrevi[/fade].

[eaten-signature]Arcanista-Mor Lythienne Vael[/eaten-signature]
`.trim();

function parseCarta(raw){
  // Ordem: primeiro substitu√≠mos marca√ß√µes ‚Üí spans; depois quebras de linha duplas ‚Üí <p>
  let t = raw;

  // bloco "trecho ileg√≠vel" especial
  t = t.replace(/\[burned\]\[trecho ileg√≠vel[^\]]*\]\[\/burned\]/gi, '<span class="fx-missing" aria-label="trecho ileg√≠vel"></span>');

  // marca√ß√µes
  t = t.replace(/\[fade\]([\s\S]*?)\[\/fade\]/gi, '<span class="fx-fade">$1</span>');
  t = t.replace(/\[glitch\]([\s\S]*?)\[\/glitch\]/gi, '<span class="fx-glitch" data-glitch="1">$1</span>');
  t = t.replace(/\[glow-purple\]([\s\S]*?)\[\/glow-purple\]/gi, '<span class="fx-glow">$1</span>');
  t = t.replace(/\[blur\]([\s\S]*?)\[\/blur\]/gi, '<span class="fx-blur">$1</span>');
  t = t.replace(/\[burned\]([\s\S]*?)\[\/burned\]/gi, '<span class="fx-burned">$1</span>');
  t = t.replace(/\[highlight\]([\s\S]*?)\[\/highlight\]/gi, '<span class="fx-highlight">$1</span>');
  t = t.replace(/\[eaten-signature\]([\s\S]*?)\[\/eaten-signature\]/gi, '<span class="fx-eaten">$1</span>');
  // NOVO blink
  t = t.replace(/\[blink\]([\s\S]*?)\[\/blink\]/gi, '<span class="fx-blink" data-shadow="$1">$1</span>');

  // palavras "marcadas" adicionais (sem exibir tags)
  t = t
    .replace(/(?<!\w)(mem√≥ria|memoria)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>')
    .replace(/(?<!\w)(engrenagem)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>')
    .replace(/(?<!\w)(nome)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>')
    .replace(/(?<!\w)(esquecer|esquec[e√™]u|esquecida|esquecido)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>')
    .replace(/(?<!\w)(morrer|morrendo)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>')
    .replace(/(?<!\w)(limite)(?!\w)/gi, '<span class="fx-blink" data-shadow="$1">$1</span>');

  // blocos ‚Üí par√°grafos
  const parts = t.split(/\n\s*\n/);
  return parts.map(p=>`<p>${p.replace(/  \n/g,'<br>')}</p>`).join('\n');
}
const cartaEl = document.getElementById('carta');
cartaEl.innerHTML = `<h1>-- Carta recuperada --</h1>\n` + parseCarta(RAW_TEXT);

// glitch leve aleat√≥rio
const GLYPHS = "·ö†·ö°·ö¢·ö¶·ö®·ö±·ö≤·ö∑·ö∫·õÉ·õá·õà·õâ·õè·õí·õó·õö·õü‚óä‚óá‚óÜ‚ñ≥‚ñΩ‚úß‚ú¶‚ú∑‚ú¥‚ú∂‚úπ";
function glitchOnce(el, dur=90){
  if(el.dataset.glitching === "1") return;
  el.dataset.glitching = "1";
  const orig = el.textContent;
  const arr = orig.split("");
  const n = Math.ceil(arr.length * 0.18);
  const idxs = new Set();
  while(idxs.size < n) idxs.add( Math.floor(Math.random()*arr.length) );
  const mutated = arr.map((ch,i)=> idxs.has(i) && ch.trim()? GLYPHS[Math.floor(Math.random()*GLYPHS.length)] : ch ).join("");
  el.textContent = mutated;
  requestAnimationFrame(()=>{
    setTimeout(()=>{ el.textContent = orig; el.dataset.glitching = "0"; }, dur);
  });
}
setInterval(()=>{
  document.querySelectorAll('.fx-glitch[data-glitch="1"]').forEach(el=>{
    if(Math.random() < 0.14) glitchOnce(el, 80 + Math.random()*120);
  });
}, 260);

/* =================== CAP√çTULO 2 (Resumo do Mundo) =================== */
const WORLD_PARAGRAPHS = [
  "  Greyspire n√£o √© uma cidade: √© um sobrevivente que ainda respira porque ningu√©m teve coragem de dizer que j√° morreu. O que a mant√©m de p√© n√£o √© esperan√ßa, nem f√©, nem gl√≥ria do Imp√©rio. √â controle. Controle sobre mem√≥ria, corpo, magia, nascimento, pensamento. O que chamam de ordem √© apenas a forma mais lenta de colapso j√° registrada.",
  "  A Guerra Arcana terminou, mas n√£o houve paz. O Imp√©rio venceu de um modo t√£o absoluto que destruiu a pr√≥pria fun√ß√£o da vit√≥ria. A Federa√ß√£o n√£o foi derrotada. Foi removida como se fosse um erro de escrita na realidade. O mapa continuou existindo, mas o territ√≥rio n√£o. E no lugar onde ela deveria estar, permanece a Fenda, um intervalo imposs√≠vel entre o que foi e o que ainda n√£o aceitou que acabou. Ela n√£o avan√ßa. N√£o recua. S√≥ espera.",
  "  Greyspire sobrevive porque n√£o ousa encarar o mundo como ele √©. Tudo aqui √© estabilizado √† for√ßa. As pessoas dormem porque algo sonha no lugar delas. A cidade se mant√©m s√£ porque outra parte do mundo enlouquece no lugar dela. Todos sentem. Quase ningu√©m admite.",
  "  Sob as ruas, a Engrenagem Perp√©tua gira sem descanso. N√£o h√° acesso, n√£o h√° explica√ß√£o oficial, n√£o h√° registro p√∫blico. S√≥ som. Um som que vibra nos ossos, mesmo quando ningu√©m percebe. A Liturgia repete que a Engrenagem nos protege, mas nunca diz do qu√™. E nunca diz o que ela exige em troca. S√≥ ordena sil√™ncio. E o sil√™ncio obedece.",
  "  Cada pessoa nasce marcada. Ningu√©m escolhe a pr√≥pria runa. Ela aparece na pele antes do choro, como se o corpo fosse apenas um r√≥tulo para algo que j√° estava decidido. A runa define o que voc√™ pode fazer, o que voc√™ ser√° autorizado a sonhar, e quanto da sua exist√™ncia ser√° considerado √∫til. N√£o existem cidad√£os sem runa. S√≥ sombras. S√≥ pessoas que desistiram de existir antes de serem oficialmente apagadas.",
  "  A hierarquia √© simples. Magia √© valor. Poder arcano compra direitos. Falta de poder compra desaparecimento. Os que dominam suas marcas ocupam as camadas mais altas da cidade e das catedrais r√∫nicas. Os que mal controlam a pr√≥pria ess√™ncia trabalham nas f√°bricas e nas muralhas. Os que nascem sem marca sequer recebem nome oficial. S√£o tolerados enquanto permanecem invis√≠veis.",
  "  O sensorium, a energia roxa que move a cidade, est√° diferente. Mais denso. Mais vivo. Alguns dizem que ele est√° absorvendo pensamentos. Outros que ele est√° adquirindo vontade. H√° quem tenha visto m√°quinas agir sozinhas. H√° quem tenha visto feiti√ßos agir contra quem os lan√ßou. H√° quem tenha visto a pr√≥pria runa piscar como se fosse um olho. N√£o h√° provas. S√≥ desaparecimentos.",
  "  A Liturgia diz que tudo est√° sob controle. A Liturgia sempre diz isso. Mesmo quando as runas mudam forma. Mesmo quando pessoas voltam com outra voz. Mesmo quando as ruas mudam de dire√ß√£o durante a noite. Mesmo quando crian√ßas nascem com marcas que n√£o constam nos c√≥digos.",
  "  A Fenda ainda pulsa. A Engrenagem gira cada vez mais r√°pido. O sensorium aumenta como mar√©. A cidade continua fingindo que tudo √© est√°vel. E h√° algo de profundamente errado na forma como ningu√©m mais se espanta.",
  "  Voc√™s n√£o precisam ser her√≥is. N√£o precisam ser salvadores. S√≥ precisam existir dentro disso. E existir, em Greyspire, j√° √© uma forma de amea√ßa. Uns ser√£o absorvidos. Outros ser√£o apagados. Poucos ser√£o lembrados.",
  "  Se querem saber quem voc√™s s√£o, n√£o perguntem a si mesmos. Perguntem quanto da sua mente ainda pertence a voc√™s."
];
document.getElementById('world-text').innerHTML =
  WORLD_PARAGRAPHS.map(p=>`<p style="text-indent:2ch">${p}</p>`).join("");

/* =================== CALCULADORA (4‚Äì15, 27 pts) =================== */
const ATTRS=["For√ßa","Destreza","Constitui√ß√£o","Intelig√™ncia","Sabedoria","Carisma"];
const KEY=["str","dex","con","int","wis","cha"];
const COST={4:-4,5:-3,6:-2,7:-1,8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};
const CLASSES={
  "Barbarian":["Path of the Berserker","Path of the Totem Warrior","Path of the Ancestral Guardian","Path of the Storm Herald","Path of the Zealot","Path of the Beast","Path of Wild Magic"],
  "Bard":["College of Lore","College of Valor","College of Glamour","College of Swords","College of Whispers","College of Creation","College of Eloquence"],
  "Cleric":["Knowledge","Life","Light","Nature","Tempest","Trickery","War","Forge","Grave","Order","Peace","Twilight"],
  "Druid":["Circle of the Land","Circle of the Moon","Circle of Dreams","Circle of the Shepherd","Circle of Spores","Circle of Stars","Circle of Wildfire"],
  "Fighter":["Champion","Battle Master","Eldritch Knight","Arcane Archer","Cavalier","Samurai","Psi Warrior","Rune Knight","Echo Knight"],
  "Monk":["Way of the Open Hand","Way of Shadow","Way of the Four Elements","Sun Soul","Kensei","Drunken Master","Mercy","Astral Self"],
  "Paladin":["Oath of Devotion","Oath of the Ancients","Oath of Vengeance","Oath of Conquest","Oath of Redemption","Oath of Glory","Oath of the Watchers"],
  "Ranger":["Hunter","Beast Master","Gloom Stalker","Horizon Walker","Monster Slayer","Fey Wanderer","Swarmkeeper"],
  "Rogue":["Thief","Assassin","Arcane Trickster","Inquisitive","Mastermind","Scout","Swashbuckler","Phantom","Soulknife"],
  "Sorcerer":["Draconic Bloodline","Wild Magic","Divine Soul","Shadow Magic","Storm Sorcery","Aberrant Mind","Clockwork Soul"],
  "Warlock":["The Archfey","The Fiend","The Great Old One","The Celestial","The Hexblade","The Fathomless","The Genie","Undead"],
  "Wizard":["School of Abjuration","Conjuration","Divination","Enchantment","Evocation","Illusion","Necromancy","Transmutation","Bladesinging","Graviturgy","Chronurgy"],
  "Artificer":["Alchemist","Armorer","Artillerist","Battle Smith"]
};
const RUNES = [
  { id:"rust", name:"Runa da Ferrugem (+2 CON)", type:"fixed", bonus:{con:2} },
  { id:"memory", name:"Runa da Lembran√ßa (+2 SAB)", type:"fixed", bonus:{wis:2} },
  { id:"vigil", name:"Runa da Vig√≠lia (+2 DES)", type:"fixed", bonus:{dex:2} },
  { id:"scar", name:"Runa da Cicatriz (+2 FOR)", type:"fixed", bonus:{str:2} },
  { id:"echo", name:"Runa do Eco (+2 CAR)", type:"fixed", bonus:{cha:2} },
  { id:"void", name:"Runa do Vazio (+2 INT)", type:"fixed", bonus:{int:2} },
  { id:"entropy", name:"Runa da Entropia (+1 em dois atributos √† escolha)", type:"two", bonus:{} },
  { id:"coldflame", name:"Runa da Chama Fria (+2 CAR ou INT)", type:"one", options:["cha","int"] },
  { id:"innerbone", name:"Runa do Osso Interior (+2 SAB ou CON)", type:"one", options:["wis","con"] },
  { id:"rupture", name:"Runa da Ruptura (+2 em qualquer atributo)", type:"one-any" },
  { id:"shard", name:"Runa da Fragmenta√ß√£o (indispon√≠vel)", type:"locked", bonus:{} }
];
const state = { base:{str:8,dex:8,con:8,int:8,wis:8,cha:8}, cls:"Fighter", subcls:"Champion", rune:"rust", runeChoice1:null, runeChoice2:null };
const el = {
  cls: document.getElementById("cls"),
  subcls: document.getElementById("subcls"),
  rune: document.getElementById("rune"),
  runeExtras: document.getElementById("runeExtras"),
  rc1Wrap: document.getElementById("runeChoice1Wrap"),
  rc2Wrap: document.getElementById("runeChoice2Wrap"),
  rc1: document.getElementById("runeChoice1"),
  rc2: document.getElementById("runeChoice2"),
  ptsLeft: document.getElementById("ptsLeft"),
  costTotal: document.getElementById("costTotal"),
  validPB: document.getElementById("validPB"),
  stats: document.getElementById("statsGrid"),
  bar: document.getElementById("bar"),
  finalTable: document.getElementById("finalTable"),
  capWarn: document.getElementById("capWarn"),
  summary: document.getElementById("sumText"),
  warnings: document.getElementById("warnings"),
  reset: document.getElementById("reset"),
  export: document.getElementById("export"),
  import: document.getElementById("import")
};
function initClassUI(){ el.cls.innerHTML = Object.keys(CLASSES).map(c=>`<option value="${c}">${c}</option>`).join(""); el.cls.value = state.cls; fillSubclass(); }
function fillSubclass(){
  const subs = CLASSES[el.cls.value] || [];
  el.subcls.innerHTML = subs.map(s=>`<option value="${s}">${s}</option>`).join("");
  if (!subs.includes(state.subcls)) state.subcls = subs[0] || "";
  el.subcls.value = state.subcls;
}
function initRunes(){
  el.rune.innerHTML = RUNES.map(r => r.id==="shard" ? `<option value="${r.id}" disabled>üîí ${r.name}</option>` : `<option value="${r.id}">${r.name}</option>`).join("");
  el.rune.value = state.rune; initRuneChoiceUI();
}
function makeAttrOptions(){ return KEY.map((k,i)=>`<option value="${k}">${ATTRS[i]}</option>`).join(""); }
function initRuneChoiceUI(){
  const r = RUNES.find(x=>x.id===el.rune.value);
  el.runeExtras.classList.remove("show");
  el.rc1Wrap.style.display = "none";
  el.rc2Wrap.style.display = "none";
  if (!r) return;
  if (r.type==="one"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc1.innerHTML = r.options.map(k=>`<option value="${k}">${ATTRS[KEY.indexOf(k)]}</option>`).join("");
    if (!r.options.includes(state.runeChoice1)) state.runeChoice1 = r.options[0];
    el.rc1.value = state.runeChoice1;
  } else if (r.type==="one-any"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc1.innerHTML = makeAttrOptions();
    if (!KEY.includes(state.runeChoice1)) state.runeChoice1 = "str";
    el.rc1.value = state.runeChoice1;
  } else if (r.type==="two"){
    el.runeExtras.classList.add("show");
    el.rc1Wrap.style.display = "block";
    el.rc2Wrap.style.display = "block";
    el.rc1.innerHTML = makeAttrOptions();
    el.rc2.innerHTML = makeAttrOptions();
    if (!KEY.includes(state.runeChoice1) || state.runeChoice1==null) state.runeChoice1 = "str";
    if (!KEY.includes(state.runeChoice2) || state.runeChoice2==null) state.runeChoice2 = "dex";
    el.rc1.value = state.runeChoice1; el.rc2.value = state.runeChoice2;
  }
}
function scoreCost(v){ if (v<4 || v>15) return Infinity; return COST[v]; }
function totalCost(base){ return KEY.reduce((sum,k)=>sum + scoreCost(base[k]), 0); }
function pointsLeft(base){ const cost = totalCost(base); return 27 - cost; }
function canInc(base,k){ const v=base[k]; if (v>=15) return false; const hypot={...base,[k]:v+1}; return totalCost(hypot)<=27; }
function canDec(base,k){ return base[k]>4; }
function applyRune(base){
  const after = {...base};
  const r = RUNES.find(x=>x.id===el.rune.value);
  let bonus = {str:0,dex:0,con:0,int:0,wis:0,cha:0};
  if (!r) return {after, bonus};
  if (r.type==="fixed"){ bonus = {...bonus, ...r.bonus}; }
  else if (r.type==="one" || r.type==="one-any"){ if (el.rc1.value){ bonus[el.rc1.value] += 2; } }
  else if (r.type==="two"){ if (el.rc1.value) bonus[el.rc1.value] += 1; if (el.rc2.value) bonus[el.rc2.value] += 1; }
  KEY.forEach(k => { after[k] = base[k] + bonus[k]; });
  return {after, bonus};
}
function modOf(score){ return Math.floor((score - 10)/2); }

function renderStats(){
  el.stats.innerHTML = KEY.map((k,i)=>{
    const v = state.base[k];
    const cost = scoreCost(v);
    const badgeCls = (cost<0) ? "gain" : "spend";
    const costTxt = (cost>0?"+":"") + cost;
    return `
      <div class="stat" data-k="${k}">
        <h3>${ATTRS[i]}</h3>
        <div class="val">
          <button class="btn-ghost" data-act="dec" ${!canDec(state.base,k)?"disabled":""}>‚Äì</button>
          <div class="n">${v}</div>
          <button class="btn-ghost" data-act="inc" ${!canInc(state.base,k)?"disabled":""}>+</button>
        </div>
        <div class="meta" style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted)">
          <span class="${(v<4 || v>15) ? "warning":""}">Limite: 4‚Äì15</span>
          <span class="cost-badge ${badgeCls}" style="border:1px solid var(--border); padding:2px 8px">Custo: ${Number.isFinite(cost)?costTxt:"--"}</span>
        </div>
      </div>
    `;
  }).join("");
  el.stats.querySelectorAll(".btn-ghost").forEach(btn=>{
    btn.onclick = () => {
      const card = btn.closest(".stat");
      const k = card.dataset.k;
      const act = btn.dataset.act;
      if (act==="inc" && canInc(state.base,k)) state.base[k]++;
      if (act==="dec" && canDec(state.base,k)) state.base[k]--;
      updateAll();
    };
  });
}
function renderTotals(){
  const cost = totalCost(state.base);
  const left = pointsLeft(state.base);
  el.ptsLeft.textContent = left;
  el.costTotal.textContent = cost;
  el.validPB.textContent = (cost<=27) ? "Sim" : "N√£o";
  el.validPB.className = (cost<=27) ? "ok" : "warning";
  const used = Math.min(27, Math.max(0, cost));
  el.bar.style.width = Math.round((used/27)*100) + "%";
}
function renderResult(){
  const {after, bonus} = applyRune(state.base);
  let capWarn = [];
  let anyWarn = false;
  el.finalTable.innerHTML = KEY.map((k,i)=>{
    const pre = state.base[k];
    const bn = bonus[k]||0;
    const post = after[k];
    if (post>20){ capWarn.push(`${ATTRS[i]} ${post} (>20)`); anyWarn = true; }
    const m = modOf(post);
    return `
      <tr>
        <td style="text-align:left">${ATTRS[i]}</td>
        <td>${pre}</td>
        <td>${bn>=0?`+${bn}`:bn}</td>
        <td>${post}</td>
        <td>${m>=0?`+${m}`:m}</td>
      </tr>
    `;
  }).join("");
  el.capWarn.textContent = capWarn.length ? `Limite 20 excedido em: ${capWarn.join(", ")}` : "--";
  const cls = el.cls.value, sub = el.subcls.value;
  const runeName = RUNES.find(r=>r.id===el.rune.value)?.name || "--";
  el.summary.textContent = `Classe: ${cls} -- Subclasse: ${sub} -- Runa: ${runeName}`;
  el.warnings.textContent = anyWarn ? "Aten√ß√£o aos limites de 20." : "";
}
function updateAll(){ renderStats(); renderTotals(); renderResult(); }
function exportBuild(){
  const data = {
    base:state.base, cls:el.cls.value, subcls:el.subcls.value, rune:el.rune.value,
    runeChoice1: document.getElementById("runeChoice1")?.value ?? null,
    runeChoice2: document.getElementById("runeChoice2")?.value ?? null
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "build-pointbuy.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importBuild(file){
  const fr = new FileReader();
  fr.onload = () => {
    try{
      const j = JSON.parse(fr.result);
      if (j.base) state.base = {...state.base, ...j.base};
      if (j.cls) { state.cls = j.cls; el.cls.value = j.cls; fillSubclass(); }
      if (j.subcls) { state.subcls = j.subcls; el.subcls.value = j.subcls; }
      if (j.rune) { state.rune = j.rune; el.rune.value = j.rune; }
      if (j.runeChoice1) state.runeChoice1 = j.runeChoice1;
      if (j.runeChoice2) state.runeChoice2 = j.runeChoice2;
      initRuneChoiceUI(); updateAll();
    }catch(e){ alert("JSON inv√°lido."); }
  };
  fr.readAsText(file);
}
el.cls.onchange = () => { state.cls = el.cls.value; fillSubclass(); updateAll(); };
el.subcls.onchange = () => { state.subcls = el.subcls.value; updateAll(); };
el.rune.onchange = () => { state.rune = el.rune.value; initRuneChoiceUI(); updateAll(); };
document.addEventListener("change", (event) => {
  if (event.target.id === "runeChoice1") { state.runeChoice1 = event.target.value; updateAll(); }
  if (event.target.id === "runeChoice2") { state.runeChoice2 = event.target.value; updateAll(); }
});
el.reset.onclick = () => { KEY.forEach(k=>state.base[k]=8); updateAll(); };
el.export.onclick = exportBuild;
el.import.onchange = (e)=>{ if (e.target.files[0]) importBuild(e.target.files[0]); };

(function boot(){
  initClassUI(); initRunes(); renderStats(); renderTotals(); renderResult();
})();
</script>
</body>
</html>

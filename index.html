<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
                 user-scalable=no, viewport-fit=cover"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Pergaminho Arcano — Reescrito (Seguro)</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet"/>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>

  <style>
    :root { --arcana: #b24cff; }

    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background: #000; color: #fff;
      font-family: 'MedievalSharp', cursive;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    /* Camadas */
    #stage       { position: fixed; inset: 0; z-index: 0; display: block; pointer-events: none !important; }
    #ui          { position: fixed; inset: 0; z-index: 20; display: grid; grid-template-rows: 1fr; }

    /* Selo clicável garantido */
    #seal-layer  { display: grid; place-items: center; pointer-events: auto; }
    #seal-button {
      appearance: none; -webkit-appearance: none;
      border: 0; background: transparent; cursor: pointer;
      display: grid; gap: 10px; place-items: center;
      padding: 0; margin: 0; outline: none;
      pointer-events: auto;
    }
    #seal-img {
      width: 160px; height: auto;
      filter: drop-shadow(0 0 24px var(--arcana));
      transition: transform .15s ease, opacity .25s ease, filter .25s ease;
      pointer-events: auto;
    }
    #seal-button:active #seal-img { transform: scale(.98); }
    #seal-hint { font-size: 14px; opacity: .9; user-select: none; }

    .hidden { display: none !important; }

    /* Interstitial */
    #interstitial { display: none; place-items: center; text-align: center; padding: 24px; }
    #interstitial.show { display: grid; }
    .interstitial-text {
      font-size: clamp(20px, 4vw, 36px);
      text-shadow: 0 0 10px var(--arcana), 0 0 20px var(--arcana), 0 0 30px var(--arcana);
      animation: iglow 2.8s ease-in-out infinite;
    }
    @keyframes iglow {
      0%,100% { text-shadow: 0 0 10px #fff, 0 0 18px var(--arcana), 0 0 28px var(--arcana); }
      50%     { text-shadow: 0 0 16px #fff, 0 0 32px var(--arcana), 0 0 50px var(--arcana), 0 0 70px var(--arcana); }
    }

    /* Assinatura final */
    #signature-container {
      position: fixed; left: 50%; bottom: 110px; transform: translateX(-50%);
      text-align: center; max-width: 640px; line-height: 1.35;
      display: none; z-index: 25;
    }
    #signature {
      text-shadow: 0 0 6px #fff, 0 0 12px var(--arcana), 0 0 18px var(--arcana);
      animation: pulse 1.4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { text-shadow: 0 0 6px #fff, 0 0 12px var(--arcana), 0 0 18px var(--arcana); }
      50%     { text-shadow: 0 0 10px #fff, 0 0 22px var(--arcana), 0 0 32px var(--arcana), 0 0 45px var(--arcana); }
    }

    /* Blindagem total: nada além do selo captura cliques */
    canvas, #stage, #stage * { pointer-events: none !important; }
    #seal-layer, #seal-layer * { pointer-events: auto !important; }
  </style>
</head>
<body>
  <!-- Canvas WebGL (apenas se 3D habilitado, senão fica preto e não bloqueia cliques) -->
  <canvas id="stage"></canvas>

  <!-- UI -->
  <div id="ui" aria-hidden="false">
    <!-- Selo -->
    <div id="seal-layer">
      <button id="seal-button" tabindex="0" aria-label="Entrar">
        <img id="seal-img" src="./selo-arcano.png" alt="Selo Arcano"
             onerror="this.onerror=null; this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAAAAYLlVAAAAPElEQVR42u3PMQEAIAzAsK3/0c6gC3gRUk4kq3gkAAAAAAAAAAAAAAD4V1Hk8c3cH0s0i8kq3uB8v1eU2m1oA1QAAq3w4e7a7dQAAAABJRU5ErkJggg==';">
        <span id="seal-hint">toque/click para invocar</span>
      </button>
    </div>

    <!-- Interstitial -->
    <div id="interstitial">
      <div class="interstitial-text">Sua mente é preenchida por um fluxo de pensamentos</div>
    </div>
  </div>

  <!-- Assinatura -->
  <div id="signature-container">
    <p id="signature">
      O coração dispara antes que você perceba que deixou a carta cair. O papel atinge o chão, mas a sensação de contato não some com ele. Algo fica preso na sua cabeça, como se um pensamento entrasse sem pedir permissão. Não é visão, nem sonho. É lembrança de algo que você nunca viveu.<br><br>
      A imagem vem inteira, sem construção, sem origem: uma taverna que você nunca viu, mas reconhece. Tábuas escuras, cheiro de ferrugem, luz baixa demais para ser aconchegante, mesas que já desistiram de permanecer retas. Ferrugem & Ossos. Velha Chama. O nome surge pronto, como se sempre estivesse guardado em algum ponto da sua mente que não era seu.<br><br>
      Ninguém diz que você deve ir.<br>
      Mas a sensação é de que você já está atrasado.
    </p>
  </div>

  <!-- App -->
  <script type="module">
    /* ========== Texto ========== */
    const TEXT = `Nas entranhas do real, onde a forma range,
eles caminham sem saber que já foram colhidos.
O mundo fede antes de morrer,
mas vós chamais isso de ordem.
Sob a pedra há dente,
sob o dente há fome,
sob a fome há ritmo,
e o ritmo vos aguarda.
Eles respiram, mas o ar não os quer.
A carne permanece, mas a lembrança apodrece.
O tempo só mastiga o que ainda resiste,
e nada resiste por muito.
O eixo tritura o que ousa lembrar.
A cidade dorme sobre ossos que não consentem.
Chama-se paz ao que sangra devagar,
chama-se vida ao que ainda não cedeu.
Vós sois as falhas do esquecimento,
os nomes que o silêncio não digeriu.
A Fenda não oferece escolha —
apenas retorno.
A vinda já começou
antes do passo.
A queda já vos guarda
antes da borda.
Ouçam.
Desçam.
Cedam.
Retornem.
A pele racha.
O selo abre.
A ruína respira.
E vos chama.`;

    /* ========== Áudio ========== */
    const sfx1  = new Howl({ src: ['./sfx1.mp3'], volume: 0.9 });
    const sfx2  = new Howl({ src: ['./sfx2.mp3'], volume: 0.6, loop:true });
    const sfx25 = new Howl({ src: ['./sfx2_5.mp3'], volume: 1.0, loop:true });
    const sfx3  = new Howl({ src: ['./sfx3.mp3'], volume: 0.7 });

    /* ========== Troika Text (SDF) ========== */
    import * as THREE from "https://unpkg.com/three@0.155.0/build/three.module.js";
    import { Text }  from "https://unpkg.com/troika-three-text@0.49.0/dist/troika-three-text.esm.js";

    /* ========== Cena ========== */
    const canvas   = document.getElementById('stage');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
    const scene    = new THREE.Scene();
    const camera   = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 5000);
    camera.position.set(0, 0, 200);
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setClearColor(0x000000, 1);
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));

    // Fundo glow
    const glow = new THREE.Mesh(
      new THREE.PlaneGeometry(2,2),
      new THREE.MeshBasicMaterial({ color: new THREE.Color('#b24cff'), transparent:true, opacity:0.2 })
    );
    glow.scale.set(600, 600, 1);
    glow.position.z = -50;
    scene.add(glow);

    // Grupo do texto
    const crawl = new THREE.Group();
    scene.add(crawl);

    // Texto SDF
    const text = new Text();
    text.text = TEXT;
    text.fontSize = 5.2;
    text.maxWidth = Math.min(innerWidth * 0.36, 360);
    text.lineHeight = 1.28;
    text.textAlign = 'center';
    text.color = 0xffffff;
    text.font = 'https://fonts.gstatic.com/s/uncialantiqua/v19/N0bM2S5C8e7-ht7PwhWQaP5B.woff';
    text.anchorX = 'center';
    text.anchorY = 'top';
    text.depthOffset = -1;
    text.outlineWidth = 0;
    text.sync();
    crawl.add(text);

    // Resize
    function fit() {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      text.maxWidth = Math.min(innerWidth * 0.36, 360);
      text.fontSize = Math.max(3.8, Math.min(6.2, innerHeight / 120));
      text.sync();
    }
    addEventListener('resize', fit, { passive:true });
    fit();

    /* ========== UI ========== */
    const sealLayer = document.getElementById('seal-layer');
    const sealBtn   = document.getElementById('seal-button');
    const sealImg   = document.getElementById('seal-img');
    const inter     = document.getElementById('interstitial');
    const sigWrap   = document.getElementById('signature-container');

    // Bind de clique radical (todos os eventos relevantes)
    function bindStart(el) {
      el.addEventListener('click',     start, { passive:false });
      el.addEventListener('pointerup', start, { passive:false });
      el.addEventListener('pointerdown', (e)=>e.preventDefault(), { passive:false });
      el.addEventListener('touchstart',(e)=>{ e.preventDefault(); start(e); }, { passive:false });
      el.addEventListener('keydown',   (e)=>{ const k=e.key||e.code||''; if(k==='Enter'||k===' '||k==='Space'){ e.preventDefault(); start(e); }}, { passive:false });
    }
    bindStart(sealBtn);
    bindStart(sealImg);
    bindStart(sealLayer);

    let running=false;

    function start(e){
      if(running) return;
      running=true;

      // Feedback visual do selo
      sealImg.style.opacity = '0';
      sealImg.style.filter  = 'drop-shadow(0 0 5px var(--arcana))';
      setTimeout(()=>{ sealLayer.classList.add('hidden'); }, 250);

      // Interstitial
      inter.classList.add('show');
      inter.style.opacity='0';
      gsap.to(inter, { opacity:1, duration:.25, onComplete(){
        gsap.to(inter, { opacity:0, delay:2.6, duration:.5, onComplete(){
          inter.classList.remove('show');
        }});
      }});

      // Áudio
      sfx1.play();
      setTimeout(()=>{ sfx2.play(); sfx25.play(); }, 1000);

      // Inicia scroll
      text.sync();
      const approxLines = TEXT.split('\n').length + 8;
      const approxHeight = approxLines * text.fontSize * text.lineHeight;

      crawl.position.set(0, approxHeight * 0.6, 0);
      gsap.to(crawl.position, {
        y: -approxHeight * 0.65,
        duration: 55,
        ease: "none",
        onComplete(){
          sfx2.stop(); sfx25.stop(); sfx3.play();
          sigWrap.style.display = 'block';
          gsap.fromTo(sigWrap, {opacity:0}, {opacity:1, duration:1.2});
        }
      });
    }

    /* ========== Loop ========== */
    const clock=new THREE.Clock();
    (function loop(){
      const t = clock.getElapsedTime();
      glow.material.opacity = 0.18 + Math.sin(t * 1.6) * 0.06;
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>O Pergaminho Arcano</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    :root { --cor-arcana:#b24cff; }

    html, body {
      margin:0; padding:0; width:100%; height:100%;
      background:#000; color:#fff; font-family:'MedievalSharp', cursive;
      overflow:hidden;
    }

    /* Selo central */
    #seal-container{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:160px; height:160px; display:flex; justify-content:center; align-items:center;
      cursor:pointer; z-index:20; pointer-events:auto;
    }
    #arcane-seal-img{
      width:120px; height:auto; pointer-events:auto;
      filter:drop-shadow(0 0 22px var(--cor-arcana));
      transition:opacity .4s ease-out, filter .4s ease-out;
    }
    #arcane-seal-img.clicked{ opacity:0; filter:drop-shadow(0 0 5px var(--cor-arcana)); }

    /* Canvas Three.js */
    #three-canvas{ position:fixed; top:0; left:0; z-index:1; }

    /* Intersticial */
    #interstitial{
      display:none; opacity:0;
      position:fixed; inset:0; z-index:9;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
      background:transparent;
      transition:opacity .5s ease;
    }
    #interstitial.show{ opacity:1; }
    #interstitial.hide{ opacity:0; }

    .interstitial-text{
      max-width: 800px; padding:0 24px; text-align:center;
      font-size: clamp(20px, 4vw, 36px);
      color:#fff;
      text-shadow: 0 0 10px var(--cor-arcana), 0 0 20px var(--cor-arcana);
      animation: distortPulse 1.2s infinite;
      filter: brightness(1.05);
    }
    @keyframes distortPulse{
      0%{transform:skew(0deg,0deg);filter:blur(0px);}
      25%{transform:skew(0.3deg,-0.4deg);filter:blur(0.4px);}
      50%{transform:skew(-0.4deg,0.2deg);filter:blur(0.6px);}
      75%{transform:skew(0.2deg,-0.2deg);filter:blur(0.3px);}
      100%{transform:skew(0deg,0deg);filter:blur(0px);}
    }

    /* Assinatura final */
    #signature-container{
      display:none; opacity:0; position:fixed; bottom:10vh; left:50%;
      transform:translateX(-50%); z-index:10; text-align:center;
      font-size:1.2rem; font-family:'MedievalSharp', cursive;
      transition:opacity 1s ease-in;
      max-width:600px; line-height:1.35;
    }
    #signature{ color:#fff; animation:pulse-arcano 1.4s ease-in-out infinite; }
    @keyframes pulse-arcano{
      0%,100%{ text-shadow:0 0 6px #fff,0 0 12px var(--cor-arcana),0 0 18px var(--cor-arcana);}
      50%{ text-shadow:0 0 10px #fff,0 0 22px var(--cor-arcana),0 0 32px var(--cor-arcana);}
    }
  </style>
</head>
<body>

  <div id="seal-container">
    <img id="arcane-seal-img" src="./selo-arcano.png" alt="Selo Arcano">
  </div>

  <canvas id="three-canvas"></canvas>

  <div id="interstitial">
    <div class="interstitial-text">Sua mente é preenchida por um fluxo de pensamentos</div>
  </div>

  <div id="signature-container">
    <p id="signature">
O coração dispara antes que você perceba que deixou a carta cair. O papel atinge o chão, mas a sensação de contato não some com ele. Algo fica preso na sua cabeça, como se um pensamento entrasse sem pedir permissão. Não é visão, nem sonho. É lembrança de algo que você nunca viveu.<br><br>
A imagem vem inteira, sem construção, sem origem: uma taverna que você nunca viu, mas reconhece. Tábuas escuras, cheiro de ferrugem, luz baixa demais para ser aconchegante, mesas que já desistiram de permanecer retas. Ferrugem & Ossos. Velha Chama. O nome surge pronto, como se sempre estivesse guardado em algum ponto da sua mente que não era seu.<br><br>
Ninguém diz que você deve ir.<br>
Mas a sensação é de que você já está atrasado.
    </p>
  </div>

  <!-- Shaders -->
  <script type="x-shader/x-vertex" id="vertexShader">
    varying vec2 vUv;
    void main(){
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  </script>

  <script type="x-shader/x-fragment" id="fragmentShader">
    uniform sampler2D map;
    uniform float time;
    uniform vec3 glowColor;      // roxo arcano leve
    uniform float distortionStrength;

    varying vec2 vUv;

    // Ruído rápido para corrupção leve
    float rand(vec2 co){ return fract(sin(dot(co.xy, vec2(12.9898,78.233))) * 43758.5453); }

    void main(){
      vec2 uv = vUv;

      // Curvatura leve (sem "zoom" acumulado)
      float bend = 0.35;
      vec2 p = uv * 2.0 - 1.0;
      p.y = p.y + bend * (p.y * p.y);
      float perspective = 1.0 + bend * (p.y + 1.0) * 0.5;
      p /= perspective;
      vec2 warpedUv = p * 0.5 + 0.5;

      // Distorção (aumentada ~15%)
      vec2 distortedUv = warpedUv;
      float noise = (rand(warpedUv * 10.0 + time * 0.5) - 0.5) * distortionStrength;
      distortedUv.x += sin(warpedUv.y * 15.0 + time * 8.0) * noise;
      distortedUv.y += cos(warpedUv.x * 15.0 + time * 7.0) * noise;

      vec4 texel = texture2D(map, clamp(distortedUv, 0.0, 1.0));

      // Pulsação roxa leve sobre letras brancas (estilo original)
      float pulse = 0.6 + 0.4 * sin(time * 0.9);
      vec3 purpleGlow = glowColor * texel.a * pulse * 0.6;

      // Base branca (onde há texto)
      vec3 baseText = vec3(1.0) * texel.a;

      // Micro-flash preto curtíssimo (apenas no texto)
      // Intervalo ~1.2s, duração ~0.07s
      float interval = 1.2;
      float width = 0.07;
      float phase = fract(time / interval);
      float blackout = step(phase, width);     // 1 nos primeiros 'width' s de cada intervalo
      float blackoutStrength = 0.45;           // reduz brilho mas mantém legível

      vec3 color = baseText + purpleGlow;
      color = mix(color, vec3(0.0), blackout * blackoutStrength * texel.a);

      gl_FragColor = vec4(color, texel.a);
    }
  </script>

  <script>
    /* ======= TEXTO ======= */
    const LOREM_IPSUM_ARCANO = `
Nas entranhas do real, onde a forma range,
eles caminham sem saber que já foram colhidos.
O mundo fede antes de morrer,
mas vós chamais isso de ordem.

Sob a pedra há dente,
sob o dente há fome,
sob a fome há ritmo,
e o ritmo vos aguarda.

Eles respiram, mas o ar não os quer.
A carne permanece, mas a lembrança apodrece.
O tempo só mastiga o que ainda resiste,
e nada resiste por muito.

O eixo tritura o que ousa lembrar.
A cidade dorme sobre ossos que não consentem.
Chama-se paz ao que sangra devagar,
chama-se vida ao que ainda não cedeu.

Vós sois as falhas do esquecimento,
os nomes que o silêncio não digeriu.
A Fenda não oferece escolha —
apenas retorno.

A vinda já começou
antes do passo.
A queda já vos guarda
antes da borda.

Ouçam.
Desçam.
Cedam.
Retornem.

A pele racha.
O selo abre.
A ruína respira.
E vos chama.
`;

    /* ======= VARS ======= */
    let scene,camera,renderer,crawlGroup,textMesh,textHeight,animationInProgress=false,endThreshold=0,clock=new THREE.Clock();
    const ARCANE_PURPLE=new THREE.Color('#b24cff');

    function init(){
      setupScene();setupListeners();
    }

    function setupScene(){
      const canvas=document.getElementById('three-canvas');
      scene=new THREE.Scene();
      const aspect=window.innerWidth/window.innerHeight;
      camera=new THREE.PerspectiveCamera(50,aspect,1,10000);
      camera.position.set(0,130,480);
      camera.lookAt(0,0,0);
      scene.add(camera);
      renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
      renderer.setSize(window.innerWidth,window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio,3));
    }

    function setupListeners(){
      document.getElementById('seal-container').addEventListener('click',startExperience,{once:true});
      window.addEventListener('resize',onWindowResize);
    }

    function startExperience(){
      if(animationInProgress)return;
      animationInProgress=true;
      const seal=document.getElementById('arcane-seal-img');
      seal.classList.add('clicked');
      setTimeout(()=>{ document.getElementById('seal-container').style.display='none'; },400);
      // Intersticial (opcional: remover se não usar)
      // showInterstitialAndThen(0, ()=>{ createCrawlText(); animate(); });
      createCrawlText(); animate();
    }

    function createCrawlText(){
      const textCanvasObj=createTextCanvas(LOREM_IPSUM_ARCANO);
      const textCanvas=textCanvasObj.canvas;
      textHeight=textCanvasObj.cssHeight;

      const texture=new THREE.CanvasTexture(textCanvas);
      texture.minFilter=THREE.LinearFilter;
      texture.magFilter=THREE.NearestFilter; // nitidez no upscaling
      if (renderer && renderer.capabilities) {
        texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
      }
      texture.needsUpdate=true;

      const material=new THREE.ShaderMaterial({
        uniforms:{
          map:{value:texture},
          time:{value:0.0},
          glowColor:{value:ARCANE_PURPLE},
          distortionStrength:{value:0.00605} // +15% de 0.00525
        },
        vertexShader:document.getElementById('vertexShader').textContent,
        fragmentShader:document.getElementById('fragmentShader').textContent,
        transparent:true
      });

      const geometry=new THREE.PlaneGeometry(textCanvasObj.cssWidth,textCanvasObj.cssHeight);
      textMesh=new THREE.Mesh(geometry,material);
      crawlGroup=new THREE.Group();
      crawlGroup.add(textMesh);
      crawlGroup.rotation.x=0;

      const startY=-textCanvasObj.cssHeight/2-240;
      crawlGroup.position.y=startY;
      endThreshold=(textCanvasObj.cssHeight*Math.cos(crawlGroup.rotation.x))*1.1;

      scene.add(crawlGroup);
    }

    function createTextCanvas(text){
      const lines=text.split('\n');
      const isMobile=window.innerWidth<=480;
      let fontSize=isMobile?22.4:32;         // 20% menor no mobile
      let lineHeight=fontSize*1.28;
      let cssWidth=1024;

      // Altura bruta
      let cssHeight=Math.floor(lines.length*lineHeight+(fontSize*2));
      const maxCssHeight=Math.floor(window.innerHeight*0.82);

      // Auto-scale proporcional (se precisar)
      if(cssHeight>maxCssHeight){
        const scale=maxCssHeight/cssHeight;
        fontSize*=scale; lineHeight*=scale; cssWidth*=scale;
        cssHeight=Math.floor(lines.length*lineHeight+(fontSize*2));
      }

      // Alta resolução: DPR (até 3x) + supersampling 2x
      const dpr=Math.min(window.devicePixelRatio||1,3), ss=2.0;
      const canvas=document.createElement('canvas');
      canvas.width=Math.floor(cssWidth*dpr*ss);
      canvas.height=Math.floor(cssHeight*dpr*ss);

      const ctx=canvas.getContext('2d');
      ctx.imageSmoothingEnabled=false;       // sem blur no raster
      ctx.scale(dpr*ss,dpr*ss);

      // Bold real
      ctx.font=`700 ${fontSize}px 'Cinzel Decorative'`;
      ctx.fillStyle='#FFFFFF';
      ctx.textAlign='center';
      ctx.textBaseline='alphabetic';

      let y=fontSize*2;
      for(const line of lines){ ctx.fillText(line,cssWidth/2,y); y+=lineHeight; }

      return{canvas,cssWidth,cssHeight};
    }

    function animate(){
      requestAnimationFrame(animate);
      if(!animationInProgress) return;

      if(textMesh && textMesh.material && textMesh.material.uniforms.time){
        textMesh.material.uniforms.time.value = clock.getElapsedTime();
      }

      // 30% mais devagar (antes ~0.78)
      crawlGroup.position.y += 0.546;

      if(crawlGroup.position.y > endThreshold){
        finishAnimation();
      }

      renderer.render(scene,camera);
    }

    function finishAnimation(){
      animationInProgress=false;
      if(crawlGroup){
        scene.remove(crawlGroup);
        if(textMesh.geometry) textMesh.geometry.dispose();
        if(textMesh.material){
          if(textMesh.material.map) textMesh.material.map.dispose();
          textMesh.material.dispose();
        }
      }
      const signature=document.getElementById('signature-container');
      signature.style.display='block';
      setTimeout(()=>{signature.style.opacity='1';},200);
    }

    function onWindowResize(){
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    }

    init();
  </script>
</body>
</html>

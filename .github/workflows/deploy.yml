name: Auto Deploy Greyspire

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove only index/css/js
        run: |
          rm -f index.html
          rm -rf css
          rm -rf js

      - name: Recreate folders
        run: |
          mkdir -p css
          mkdir -p js

      - name: Generate index.html
        run: |
          printf "%s\n" "<!doctype html>" > index.html
          printf "%s\n" "<html lang=\"pt-br\">" >> index.html
          printf "%s\n" "<head>" >> index.html
          printf "%s\n" "  <meta charset=\"utf-8\" />" >> index.html
          printf "%s\n" "  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />" >> index.html
          printf "%s\n" "  <title>Carta de Greyspire</title>" >> index.html
          printf "%s\n" "  <link href=\"https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=MedievalSharp&display=swap\" rel=\"stylesheet\">" >> index.html
          printf "%s\n" "  <link rel=\"stylesheet\" href=\"css/estilo.css\">" >> index.html
          printf "%s\n" "</head>" >> index.html
          printf "%s\n" "<body>" >> index.html
          printf "%s\n" "<main class=\"pergaminho\" id=\"pergaminho\">" >> index.html
          printf "%s\n" "  <canvas id=\"fxCanvas\" class=\"fx-canvas\"></canvas>" >> index.html
          printf "%s\n" "  <button id=\"seloBtn\" class=\"selo-btn\" aria-label=\"Abrir carta\">" >> index.html
          printf "%s\n" "    <img src=\"img/selo.png\" alt=\"Selo arcano\" class=\"selo-img\" />" >> index.html
          printf "%s\n" "  </button>" >> index.html
          printf "%s\n" "  <section class=\"carta\" id=\"carta\" role=\"region\" aria-hidden=\"true\">" >> index.html
          printf "%s\n" "    <div class=\"conteudo\" id=\"conteudo\">" >> index.html
          printf "%s\n" "      <p>Cidade de Greyspire, remanescentes do Velho Império, 537 D.R</p>" >> index.html
          printf "%s\n" "      <p>Vocês deviam ter percebido, mas a percepção é coisa perigosa por aqui, então talvez não notem até que já seja tarde; o mundo não se quebrou num só instante, ele vai quebrando aos poucos, como vidro que racha sem barulho, e essa lentidão é o que permite que todos finjam normalidade, que chamem de rotina aquilo que só parece rotina para quem esqueceu como é estar inteiro. O Império venceu, eles repetem isso com calma, como se a repetição tornasse a mentira menos afiada; a Federação Arcana não foi simplesmente derrotada, foi riscada da fala comum, apagada como se alguém tivesse passado a mão numa página cheia de nomes que nunca mereceram existir, e a Fenda fez exatamente o que prometeram que faria, o que prova que não foi erro técnico o que aconteceu ali, foi escolha com consequências que ninguém calculou direito, achando que se podia encerrar o que foi aberto, e desde então o mundo não acabou, apenas deixou de saber fechar suas próprias feridas.</p>" >> index.html
          printf "%s\n" "      <p>Greyspire sustenta-se enquanto sabe esconder o que a sustenta, e por isso não a chamem de cidade que vive; é uma cidade que é mantida, conserva-se por medida, por prática institucionalizada, cada pessoa que nasce recebe uma runa que pouco diz sobre destino e muito diz sobre controle, marca que serve para identificação e para decidir quem fica, quem se move, quem é observado, e os sermões da Liturgia falam em ordem espiritual com uma voz que soa oficial e seca, enquanto em salas que não aparecem nos mapas oficiais acontecem coisas que não são ditas em voz alta: eu vi corredores com portas que ninguém registra, vi salas onde se repetem rituais sem comunicado público, vi corpos voltando diferentes de como saíram; eu digo isto porque sei o suficiente para ter medo, e porque sei que a drenagem, se é preciso dar nome ao que vi, não é coisa de praça nem de boato, é segredo de casta, é prática que se faz atrás de cortinas grossas e que só se pronuncia com cuidado, como quem revela um pecado que corrói a garganta.</p>" >> index.html
          printf "%s\n" "      <p>A magia existe, claro que existe, mas não como no livro didático; cada conjuro custa algo que não volta, às vezes sono, às vezes um sentimento, às vezes um nome que se apaga, e já vi mestres que falam como se as palavras fossem serras dentro da boca, e a Engrenagem Perpétua gira lá embaixo não como motor que move rodas, mas como dispositivo que compensa vazios, que adia o colapso por turnos e listas, e por isso chamam aquilo de manutenção, como se fosse possível domesticar um mal com papel e carimbo; só que agora algo mudou e não é sutileza de estatística, é sensação, e eu sinto: ela gira mais rápido, o número dos que deixam de ser contados aumentou, runas mudam sem dedo que escreva, bairros inteiros parecem sonhar acordados e sair pela manhã para andar em ruas que já não são exatamente ruas, pessoas voltam de lugares proibidos com palavras gravadas na pele, crianças nascem com marcas que não constam em nenhum livro, arquivos reescrevem-se sozinhos quando a cidade fecha os olhos.</p>" >> index.html
          printf "%s\n" "      <p>Vocês foram riscados das listas, mas não da memória que importa, e lembram de mim quando ninguém mais lembra, e isso é o erro que a cidade vai corrigir se vocês demorarem. Por isso venham. Não perguntem, não procurem provas, não tentem achar meu nome em arquivo algum porque já o arrancaram de todo lugar que pudesse apontá-lo; simplesmente apareçam no Ferrugem &amp; Ossos, no bairro Velha Chama, atrás do moinho cujas janelas foram muradas, antes da ponte que surge apenas quando chove, e venham enquanto ainda conseguem lembrar quem eram antes de serem anotados. Se chegarem cedo, talvez eu ainda esteja à mesa tentando juntar palavras que não se deixam prender. Se chegarem tarde, talvez eu ainda respire. Se chegarem muito tarde, talvez não reste nada em que vocês se reconheçam quando olharem para trás. Não peço confiança. Quero que saibam que já fazem parte da revolução.</p>" >> index.html
          printf "%s\n" "    </div>" >> index.html
          printf "%s\n" "    <div class=\"assinatura-wrap\">" >> index.html
          printf "%s\n" "      <div id=\"assinatura\" class=\"assinatura\" aria-hidden=\"true\" data-text=\"Arcanista-mor Amaris Solun\">" >> index.html
          printf "%s\n" "        <span class=\"visualmente-oculto\">Arcanista-mor Amaris Solun</span>" >> index.html
          printf "%s\n" "      </div>" >> index.html
          printf "%s\n" "    </div>" >> index.html
          printf "%s\n" "  </section>" >> index.html
          printf "%s\n" "</main>" >> index.html
          printf "%s\n" "<audio id=\"ritualAudio\" src=\"audio/ritual.mp3\" preload=\"auto\" loop></audio>" >> index.html
          printf "%s\n" "<script src=\"js/ritual.js\" defer></script>" >> index.html
          printf "%s\n" "</body>" >> index.html
          printf "%s\n" "</html>" >> index.html

      - name: Generate CSS
        run: |
          printf "%s\n" ":root{" > css/estilo.css
          printf "%s\n" "  --bg:#0b0a09;" >> css/estilo.css
          printf "%s\n" "  --purple:#b24cff;" >> css/estilo.css
          printf "%s\n" "  --bpm:60;" >> css/estilo.css
          printf "%s\n" "}" >> css/estilo.css
          printf "%s\n" "*{box-sizing:border-box;margin:0;padding:0}" >> css/estilo.css
          printf "%s\n" "html,body{height:100%}" >> css/estilo.css
          printf "%s\n" "body{background:var(--bg);display:grid;place-items:center;color:#0a0a0a;font-family:\"Uncial Antiqua\",serif;-webkit-font-smoothing:antialiased}" >> css/estilo.css
          printf "%s\n" ".pergaminho{position:relative;width:min(920px,94vw);min-height:min(760px,86vh);overflow:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,.7);background:#bca97b url(\"../img/pergaminho_base.jpg\") center/cover no-repeat;filter:saturate(1.05) contrast(1.1) brightness(0.97);isolation:isolate;transition:filter 1.4s ease}" >> css/estilo.css
          printf "%s\n" ".selo-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:0;background:transparent;cursor:pointer;z-index:3}" >> css/estilo.css
          printf "%s\n" ".selo-img{width:180px;height:180px;display:block}" >> css/estilo.css
          printf "%s\n" ".carta{position:relative;z-index:2;width:84%;max-width:820px;min-height:520px;padding:28px;border-radius:6px;text-align:justify;opacity:0;transition:opacity .8s ease}" >> css/estilo.css
          printf "%s\n" ".pergaminho.revealed .carta{opacity:1}" >> css/estilo.css
          printf "%s\n" ".conteudo p{margin:0 0 1rem 0;color:#0a0a0a;text-shadow:0 0 6px rgba(178,76,255,.18)}" >> css/estilo.css
          printf "%s\n" ".assinatura-wrap{margin-top:22px;display:flex;justify-content:flex-start}" >> css/estilo.css
          printf "%s\n" ".assinatura{position:relative;font-family:\"MedievalSharp\",cursive;font-size:26px;letter-spacing:.04em;color:#0a0a0a;opacity:0;transition:opacity 1.2s ease,transform 1.2s ease}" >> css/estilo.css
          printf "%s\n" ".pergaminho.revealed .assinatura{opacity:1;transform:scale(1)}" >> css/estilo.css

      - name: Generate JS
        run: |
          printf "%s\n" "const seloBtn=document.getElementById('seloBtn');" > js/ritual.js
          printf "%s\n" "const pergaminho=document.getElementById('pergaminho');" >> js/ritual.js
          printf "%s\n" "const carta=document.getElementById('carta');" >> js/ritual.js
          printf "%s\n" "const assinatura=document.getElementById('assinatura');" >> js/ritual.js
          printf "%s\n" "const ritualAudio=document.getElementById('ritualAudio');" >> js/ritual.js
          printf "%s\n" "let audioStarted=false;" >> js/ritual.js
          printf "%s\n" "function revelarCarta(){seloBtn.classList.add('hidden');pergaminho.classList.add('revealed');carta.setAttribute('aria-hidden','false');if(!audioStarted){ritualAudio.volume=0.8;ritualAudio.play().catch(()=>{});audioStarted=true;}}" >> js/ritual.js
          printf "%s\n" "seloBtn.addEventListener('click',revelarCarta);" >> js/ritual.js

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Auto deploy" || echo "Nada para commitar"
          git push

name: Deploy Greyspire (Main Branch Auto-Rebuild)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Limpa tudo da raiz, exceto .git e .github (modo robusto, sem extglob)
      - name: Clean main (keep .git and .github)
        shell: bash
        run: |
          set -e
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +

      - name: Create structure
        shell: bash
        run: |
          mkdir -p css js img audio

      - name: Write index.html
        shell: bash
        run: |
          cat << 'EOF' > index.html
          <!doctype html>
          <html lang="pt-br">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>Carta de Greyspire</title>
            <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=MedievalSharp&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="css/estilo.css">
          </head>
          <body>
          <main class="pergaminho" id="pergaminho">
            <canvas id="fxCanvas" class="fx-canvas"></canvas>

            <!-- Selo -->
            <button id="seloBtn" class="selo-btn" aria-label="Abrir carta">
              <img src="img/selo.png" alt="Selo arcano" class="selo-img" />
            </button>

            <!-- Carta -->
            <section class="carta" id="carta" role="region" aria-hidden="true">
              <div class="conteudo" id="conteudo">
                <p>Cidade de Greyspire, remanescentes do Velho Império, 537 D.R</p>
                <p>Vocês deviam ter percebido, mas a percepção é coisa perigosa por aqui, então talvez não notem até que já seja tarde; o mundo não se quebrou num só instante, ele vai quebrando aos poucos, como vidro que racha sem barulho, e essa lentidão é o que permite que todos finjam normalidade, que chamem de rotina aquilo que só parece rotina para quem esqueceu como é estar inteiro. O Império venceu, eles repetem isso com calma, como se a repetição tornasse a mentira menos afiada; a Federação Arcana não foi simplesmente derrotada, foi riscada da fala comum, apagada como se alguém tivesse passado a mão numa página cheia de nomes que nunca mereceram existir, e a Fenda fez exatamente o que prometeram que faria, o que prova que não foi erro técnico o que aconteceu ali, foi escolha com consequências que ninguém calculou direito, achando que se podia encerrar o que foi aberto, e desde então o mundo não acabou, apenas deixou de saber fechar suas próprias feridas.</p>
                <p>Greyspire sustenta-se enquanto sabe esconder o que a sustenta, e por isso não a chamem de cidade que vive; é uma cidade que é mantida, conserva-se por medida, por prática institucionalizada, cada pessoa que nasce recebe uma runa que pouco diz sobre destino e muito diz sobre controle, marca que serve para identificação e para decidir quem fica, quem se move, quem é observado, e os sermões da Liturgia falam em ordem espiritual com uma voz que soa oficial e seca, enquanto em salas que não aparecem nos mapas oficiais acontecem coisas que não são ditas em voz alta: eu vi corredores com portas que ninguém registra, vi salas onde se repetem rituais sem comunicado público, vi corpos voltando diferentes de como saíram; eu digo isto porque sei o suficiente para ter medo, e porque sei que a drenagem, se é preciso dar nome ao que vi, não é coisa de praça nem de boato, é segredo de casta, é prática que se faz atrás de cortinas grossas e que só se pronuncia com cuidado, como quem revela um pecado que corrói a garganta.</p>
                <p>A magia existe, claro que existe, mas não como no livro didático; cada conjuro custa algo que não volta, às vezes sono, às vezes um sentimento, às vezes um nome que se apaga, e já vi mestres que falam como se as palavras fossem serras dentro da boca, e a Engrenagem Perpétua gira lá embaixo não como motor que move rodas, mas como dispositivo que compensa vazios, que adia o colapso por turnos e listas, e por isso chamam aquilo de manutenção, como se fosse possível domesticar um mal com papel e carimbo; só que agora algo mudou e não é sutileza de estatística, é sensação, e eu sinto: ela gira mais rápido, o número dos que deixam de ser contados aumentou, runas mudam sem dedo que escreva, bairros inteiros parecem sonhar acordados e sair pela manhã para andar em ruas que já não são exatamente ruas, pessoas voltam de lugares proibidos com palavras gravadas na pele, crianças nascem com marcas que não constam em nenhum livro, arquivos reescrevem-se sozinhos quando a cidade fecha os olhos.</p>
                <p>Vocês foram riscados das listas, mas não da memória que importa, e lembram de mim quando ninguém mais lembra, e isso é o erro que a cidade vai corrigir se vocês demorarem. Por isso venham. Não perguntem, não procurem provas, não tentem achar meu nome em arquivo algum porque já o arrancaram de todo lugar que pudesse apontá-lo; simplesmente apareçam no Ferrugem &amp; Ossos, no bairro Velha Chama, atrás do moinho cujas janelas foram muradas, antes da ponte que surge apenas quando chove, e venham enquanto ainda conseguem lembrar quem eram antes de serem anotados. Se chegarem cedo, talvez eu ainda esteja à mesa tentando juntar palavras que não se deixam prender. Se chegarem tarde, talvez eu ainda respire. Se chegarem muito tarde, talvez não reste nada em que vocês se reconheçam quando olharem para trás. Não peço confiança. Quero que saibam que já fazem parte da revolução.</p>
              </div>

              <div class="assinatura-wrap">
                <div id="assinatura" class="assinatura" aria-hidden="true" data-text="Arcanista-mor Amaris Solun">
                  <span class="visually-hidden">Arcanista-mor Amaris Solun</span>
                </div>
              </div>
            </section>
          </main>

          <!-- Áudio (adicione o arquivo real em /audio/ritual.mp3) -->
          <audio id="ritualAudio" src="audio/ritual.mp3" preload="auto" loop></audio>

          <script src="js/ritual.js" defer></script>
          </body>
          </html>
          EOF

      - name: Write CSS
        shell: bash
        run: |
          cat << 'EOF' > css/estilo.css
:root{
  --bg:#0b0a09;
  --purple:#b24cff;
  --bpm:60;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:var(--bg);
  display:grid; place-items:center;
  color:#0a0a0a;
  font-family:"Uncial Antiqua", serif;
  -webkit-font-smoothing:antialiased;
}

.pergaminho{
  position:relative;
  width:min(920px,94vw);
  min-height:min(760px,86vh);
  overflow:hidden;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  border-radius:14px;
  box-shadow:0 30px 80px rgba(0,0,0,.7);
  background:#bca97b url("../img/pergaminho_base.jpg") center/cover no-repeat;
  filter:saturate(1.05) contrast(1.1) brightness(0.97);
  isolation:isolate;
  transition:filter 1.4s ease;
}
.pergaminho::before{
  content:""; position:absolute; inset:0; z-index:0;
  background:
    radial-gradient(ellipse at 50% 45%, rgba(255,230,180,.12), transparent 70%),
    radial-gradient(circle at 50% 60%, rgba(0,0,0,.45), transparent 70%);
  mix-blend-mode:multiply;
}
.pergaminho.revealed{ filter:saturate(1.12) brightness(1.03); }

@keyframes parchmentGlow {
  0%,100%{filter:saturate(1.05) brightness(0.96);}
  50%{filter:saturate(1.12) brightness(1.05);}
}
.pergaminho.pulse { animation:parchmentGlow calc(60s/var(--bpm)) ease-in-out infinite; }

.fx-canvas{
  position:absolute; inset:0; z-index:1; pointer-events:none;
}

.selo-btn{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  border:0; background:transparent; cursor:pointer; z-index:3;
}
.selo-img{ width:180px; height:180px; display:block;
  filter:drop-shadow(0 0 18px rgba(178,76,255,.4));
  transition:transform .3s ease, opacity .8s ease;
}
.selo-btn.hidden{ opacity:0; pointer-events:none; transform:translate(-50%,-50%) scale(.95); }

.carta{
  position:relative; z-index:2;
  width:84%; max-width:820px; min-height:520px;
  padding:28px; border-radius:6px;
  text-align:justify; line-height:1.7; font-size:18px; color:#0a0a0a;
  background:rgba(255,255,255,.06);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.15), inset 0 -2px 12px rgba(0,0,0,.3);
  clip-path:polygon(49.5% 0,50.5% 0,50.5% 100%,49.5% 100%);
  opacity:0;
  transition:clip-path 1.1s cubic-bezier(.2,.7,.2,1), opacity .7s ease;
}
.pergaminho.revealed .carta{
  clip-path:inset(0% 0% 0% 0% round 6px);
  opacity:1;
}

.conteudo p{
  margin: 0 0 1rem 0;
  color:#0a0a0a;
  text-shadow:0 0 6px rgba(178,76,255,.18);
}

.assinatura-wrap{
  margin-top:22px; display:flex; justify-content:flex-start;
}
.assinatura{
  position:relative;
  font-family:'MedievalSharp', cursive;
  font-size:26px; letter-spacing:.04em;
  color:#0a0a0a;
  text-shadow:
    0 0 10px rgba(178,76,255,.45),
    0 0 26px rgba(178,76,255,.30),
    0 0 50px rgba(178,76,255,.20);
  opacity:0; transform:scale(.98);
  transition:opacity 1.2s ease, transform 1.2s ease;
}
.pergaminho.revealed .assinatura{ opacity:1; transform:scale(1); }

.assinatura::before, .assinatura::after{
  content:attr(data-text);
  position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen;
}
.assinatura::before{ color:rgba(255,0,255,.28); transform:translate(1px,-1px); }
.assinatura::after { color:rgba(150,0,255,.42); transform:translate(-1px,1px); }

.spark{
  position:absolute; width:3px; height:3px; border-radius:50%;
  background:radial-gradient(circle, #ffdca3, rgba(255,255,255,0));
  pointer-events:none; animation:sparkRise 1.3s ease-out forwards;
}
@keyframes sparkRise{ 0%{opacity:1; transform:translateY(0) scale(.6)} 100%{opacity:0; transform:translateY(-70px) scale(1.5)} }

.visually-hidden{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

@media (max-width:560px){
  .carta{ padding:14px; font-size:16px; min-height:64vh }
  .assinatura{ font-size:22px }
  .selo-img{ width:140px; height:140px }
}
          EOF

      - name: Write JS
        shell: bash
        run: |
          cat << 'EOF' > js/ritual.js
const seloBtn = document.getElementById("seloBtn");
const pergaminho = document.getElementById("pergaminho");
const carta = document.getElementById("carta");
const assinatura = document.getElementById("assinatura");
const ritualAudio = document.getElementById("ritualAudio");

let audioStarted = false;

function revelarCarta() {
  seloBtn.classList.add("hidden");
  pergaminho.classList.add("revealed");
  carta.setAttribute("aria-hidden", "false");
  pergaminho.classList.add("pulse");

  setTimeout(() => assinatura.classList.add("revealed"), 900);

  if (!audioStarted) {
    ritualAudio.volume = 0.8;
    ritualAudio.play().catch(() => {});
    audioStarted = true;
  }

  iniciarParticulas();
}

seloBtn.addEventListener("click", revelarCarta);

function criarParticula() {
  const p = document.createElement("div");
  p.className = "spark";
  const rect = assinatura.getBoundingClientRect();
  p.style.left = rect.left + rect.width * Math.random() + "px";
  p.style.top = rect.top + rect.height + 8 + "px";
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 1500);
}

function iniciarParticulas() {
  setInterval(criarParticula, 1200);
}

const canvas = document.getElementById("fxCanvas");
const gl = canvas.getContext("webgl", { preserveDrawingBuffer: true });

function ajustarCanvas() {
  canvas.width = pergaminho.clientWidth;
  canvas.height = pergaminho.clientHeight;
}
ajustarCanvas();
window.addEventListener("resize", ajustarCanvas);
          EOF

      - name: Commit & Push (no-fail if no changes)
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "Sem alterações para commitar."
          else
            git commit -m "Deploy automático"
            git push origin main --force
          fi
